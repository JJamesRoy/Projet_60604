---
title: "Projet BIXI - Partie 4: Modèle linéaire mixte"
subtitle: "MATH60604 - Modélisation statistique"
author: "Abdoul Wassi Badirou, Alfred Assal, James Roy, Samuel Croteau"
date: "`r Sys.Date()`"
geometry: margin=1.5cm
output:
  # bookdown::html_document2:
  #   toc: yes
  #   number_sections: yes
  #   toc_float:
  #     collapsed: no
  # #   toc_depth: '3'
  bookdown::pdf_document2:
    toc: yes
    toc_depth: 1
    extra_dependencies: ["flafter"]
params:
  created_date: "2023-09-12"
header-includes:
#- \usepackage{tikz}
#- \usepackage{subcaption}
#- \usepackage{graphicx}
#- \usepackage{sidecap}
- \usepackage{float}
- \usepackage{amsmath}
- \usepackage{ragged2e}
#- \floatplacement{figure}{H}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE,message = FALSE,warning = FALSE,error = TRUE, fig.pos = "H")
```

```{r lib}
library(tidyverse)
library(readxl)
library(knitr)
library(googleway)
library(ggplot2)
library(car)
library(cleandata)
library(data.table)
library(kableExtra)
library(gridExtra)
library(jtools)
library(descr)
library(MASS)
library(emmeans)
library(nlme)
library(stringr)
```

```{r read}
dat = read.csv("dat_full_m.csv")
```

# Introduction

# Impact des festivals

```{r}
festivals <- data.frame(
  Start_Date = as.Date(c("2021-05-10", "2021-05-22", "2021-05-27", "2021-06-06", "2021-06-07",
                         "2021-06-07", "2021-06-07", "2021-06-11", "2021-06-13", "2021-06-14",
                         "2021-06-20", "2021-06-26", "2021-06-27", "2021-06-29", "2021-07-04",
                         "2021-07-05", "2021-07-06", "2021-07-09", "2021-07-10",
                         "2021-07-11", "2021-07-11", "2021-07-22", "2021-07-27", "2021-07-28",
                         "2021-08-02", "2021-08-06", "2021-08-07", "2021-08-08", "2021-08-09",
                         "2021-08-09", "2021-08-19", "2021-08-20", "2021-08-29", "2021-08-30")),
  End_Date = as.Date(c("2021-05-17", "2021-06-04", "2021-06-16", "2021-06-16", "2021-06-09",
                       "2021-06-16", "2021-06-09", "2021-06-16", "2021-06-16", "2021-06-22",
                       "2021-06-23", "2021-06-30", "2021-07-06", "2021-07-27", "2021-07-14",
                       "2021-07-07", "2021-07-06", "2021-07-14", "2021-07-21", "2021-07-28",
                       "2021-07-27", "2021-08-01", "2021-07-28", "2021-07-28", "2021-08-04",
                       "2021-08-14", "2021-08-11", "2021-08-18", "2021-08-10", "2021-08-18",
                       "2021-08-24", "2021-08-25", "2021-09-02", "2021-09-02"))
)

dates <- festivals %>%
  rowwise() %>%
  mutate(Date = list(seq(Start_Date, End_Date, by = "day"))) %>%
  unnest(Date)

result_df <- dates %>%
  group_by(Date) %>%
  summarize(festival = n())

dat$Date <- as.Date(paste("2021", dat$mm, dat$dd, sep = "-"))

dat <- dat %>%
  left_join(result_df, by = "Date")

dat$festival[is.na(dat$festival)] = 0

dat$log_n_tot = log(dat$n_tot)
```

Dans cette section, nous allons nous intéresser à la même question que dans la deuxième partie du travail, soit analyser si les festivals tenus dans la ville de Montréal ont un impact sur l'utilisation des Bixi. Ainsi, nous allons utiliser le log du nombres totaux des déplacements (`log_n_tot`).

Pour tester cette question, nous allons nous baser sur les données utilisées dans les parties précédentes. Il est cependant utile de respécifier comment la variable `festival`est construite. Celle-ci est une variable de décompte qui note le nombre de festivals ayant lieu cette journée. Ainsi, elle est fixe peu importe la station, tant que la journée est pareille. La variable peut prendre la valeur de 0 à 6.

En addition à un modèle de régression linéaire, comme utilisé lors de la deuxième partie, nous allons tester les effets des festivals en permettant une corrélation intra-station.

## Modèle de régression linéaire

```{r, out.height = "30%"}
mod_fest = gls(log_n_tot ~ festival + mm + holiday + wkend, data = dat)
summary(mod_fest)
```

Nous allons attendre avant d'interpréter le modèle.

Nous allons maintenant tester des modèle avec effets aléatoires pour voir s'il est possible d'améliorer l'inférence et la précision des résultats. 

## Modèle avec effets aléatoires

D'abord, pour le premier modèle avec effet, nous allons permettent une corrélation intra-station en mettant des effets aléatoire pour l'ordonnée à l'origine. Nous n'allons pas intérpréter les résultats de suite, nous allons d'abord comparer les résultats.

```{r}
mod_fest_2 <- lme(n_tot ~ festival + mm + holiday + wkend, random = ~1 | station,
data = dat)
summary(mod_fest_2)
```

Ensuite, pour le deuxième modèle, nous allons instaurer des effets aléatoires pour l'ordonnée à l'origine et pour le coefficient de festival. Nous allons aussi attendre avant d'interpréter les résultats.

```{r}
mod_fest_2a <- lme(n_tot ~ festival + mm + holiday + wkend, random = ~1 + festival |
station, data = dat)
summary(mod_fest_2a)
```

```{r}
#getVarCov(mod_fest_2a, type = "random.effects")
```

Enfin, pour le dernier modèle, il sera très similaire au dernier, mais nous allons forcer sorte  $\sigma_{\beta01}$ = 0, c’est-à-dire, avec des effets aléatoires indépendants.

```{r}
mod_fest_2b <- lme(n_tot ~ festival + mm + holiday + wkend, random = list(station = pdDiag(~1 + festival)), data = dat)
summary(mod_fest_2b)
```

```{r}
#getVarCov(mod_fest_2b, type = "random.effects")
```
### Tests sur les modèles
```{r}
anova(mod_fest_2a, mod_fest_2b, type = "LR")
```
Pour le premier test, le LRT test $H_0 : \sigma_{b01} = 0\ vs. H_1 : \sigma_{b01} \neq 0$. Comme la p-value est plus petite que 0.0001, nous pouvons rejeter $H_0$ et conclure que la corrélation entre les effets aléatoires est nécessaire (aussi supporté par le BIC et le AIC).

Nous allons ainsi comparer `mod_fest_2a` avec `mod_fest_2` pour voir s'il est nécessaire de rajouter des effets aléatoires pour la variable `festival`. Cette fois-ci nous allons les comparer avec AIC et BIC, car c'est un test non-standard.

```{r}
anova(mod_fest_2, mod_fest_2a, type = "LR")
```

Comme il est possible de le voir, AIC et BIC est légérement plus petit pour le modèle avec effets aléatoires pour la variable explicative. Ainsi, nous allons garder ce modèle et le comparer à un modèle linéaire.

```{r}
AIC_1 = AIC(mod_fest)
AIC_2 = AIC(mod_fest_2a)
BIC_1 = BIC(mod_fest)
BIC_2 = BIC(mod_fest_2a)

comparison_table <- data.frame(
  Critere = c("AIC", "BIC"),
  mod_fest = c(AIC_1, BIC_1),
  mod_fest_2a = c(AIC_2, BIC_2)
)

# Afficher le tableau
print(comparison_table)
```

Étant donné que les valeurs d'AIC et de BIC sont inférieur dans le modèle linéaire, nous allons utiliser ce modèle. Il semble donc que modéliser un intercepte et un effet aléatoire pour la variable  `festival` pour chaque sujet ne soit pas utile.

Ainsi, nous pouvons intérpréter le premier modèle (linéaire de base).

Avec ce modèle simple, la tenue de festival semble avoir un effet positif et significatif sur le nombre total de déplacements. En effet, un festival de plus par jour augmente en moyenne le nombre total de déplacement de 5% par jour par stations (toutes choses étant égales par ailleurs). De plus, cette augmentation est significatif à tout niveau de alpha raisonnable. 

# Effet de la densité de population

Précédemment nous avions étudié l’effet de la densité de population sur le nombre total de déplacements. Cependant, puisque le nombre total de déplacements est une variable de dénombrement, il est plus convenable d’utiliser un modèle linéaire généralisé. Néanmoins, puisque nos connaissances actuelles des modèles mixtes se limitent au cas des régressions linéaires. Nous avons décidé d’étudier une variable réponse différente, soit la durée de déplacement. De plus, il faut noter que puisque la densité de population est un effet d’arrondissement, alors il n’est pas nécessaire d’inclure les arrondissements dans nos modèles. C’est-à-dire qu’en incluant la densité on observe les changements qui arrivent inter-arrondissement sans avoir besoin d’inclure les arrondissements dans nos modèles. À cet égard, la densité de population est calculée de la même façon que dans la seconde partie du travail, soit la population totale par arrondissement par rapport à la superficie de l’arrondissement même. Ainsi, nous avons ajouté les données d’arrondissement selon les stations tout en y incluant la population totale et la superficie de chaque arrondissement.

Tout d'abord, chaque arrondissement contient plusieurs stations. En d’autres termes, on peut assumer qu’il risque d’y avoir une corrélation intra-station, comme expliqué dans les sections précédentes. Cette corrélation a pour effet de biaiser les tests d’hypothèse qu’on a abordés dans la deuxième partie du travail. Autrement dit, en plus d’avoir des effets de groupe inter arrondissement capté par la densité de population, nous nous retrouvons avec des effets qui varie intra stations, ce qui est problématique dans un cas d’inférence. Pour aborder cette problématique, nous allons utiliser une approche à effets aléatoire, nous permettant ainsi de ne pas utiliser une pléthore de variable explicative pour contrôler les effets de chaque station. 

Enfin, dans la seconde partie du travail, nous avions inclus d’autres variables explicatives par arrondissement, comme le nombre de parcs, le nombre de bibliothèques, le nombre de centres communautaires, etc., puisque ce sont des variables fixes par arrondissement, elles vont naturellement sur estimer l’effet de la densité si on ne les inclut pas. Néanmoins, une solution serait de contrôler aussi pour les effets inter-stations, puisque les stations sont dans les arondissement, ça nous permettrait de capter une bonne partie des effets fixes inter-arrondissements, sans avoir à inclure tous les effets d’arrondissements. Pour ce faire il est possible d'inclure les station dans nos modèle, mais aussi on pourrait inclure dans nos modèle le nombre de station par arondissement comme variable continue, ce qui permetterait de capter l'effet moyen lorsqu'on augmente le nombre de station qui est représenté dans nos données comme le moment ou l'on change d'arondissment.


## Modèle sans effet aléatoire avec structure de corélation intra-station

Il est à noter que dans ce cas, qu'on considère une structure d'équicorrélation où la structure de corrélation dans chaque station est la même. On peut voir dans le tableau anova ci-dessous la comparaison entre deux modèles, chaque modèle contient les mêmes variables. On essaye de voir l'impact de la densité de la population sur la durée de déplacement en minutes  en y incluant d'autres covariables comme le nombre de stations par arrondissement et la variable fin de semaine. On n'inclut pas les membres dans ces modèles principalement parce que la densité a un impact sur les membres, et ces derniers influent à leur tour sur la durée de déplacement. Cela créerait une boucle d'interdépendance entre la densité, les membres, et la durée de déplacement, ce qui compliquerait l'analyse et pourrait entraîner des résultats difficiles à interpréter. Enfin, la seule différence entre les deux modèles, c'est qu'on inclut dans le deuxième modèle un effet de corrélation intra-station avec une structure d'équicorrélation. Il est possible d'observer que cet effet est bien significatif pour tout niveau d’alpha raisonnable.

On ne montre pas la table de régression ici, pusique certains autres modèles risque d'être mieux adapté à la structure de nos données, donc on préfère montrer ces-dernier seulement. 

```{r}
dat$arrond <- as.factor(dat$arrond)

mod_dens_0 <- gls(dur ~ density + wkend + nb_stations, data = dat) 
mod_dens_1 <- gls(dur ~  density + wkend + nb_stations, correlation = corCompSymm(form = ~ 1|station), data = dat)

anova(mod_dens_0,mod_dens_1)

```


## Modèle avec effet aléatoire sur l'ordonnée à l'origine incluant une structure de corrélation intra-station

Dans la table anova ci-dessous, on vois la comparaison entre le fait d'ajouter un effet aléatoire avec ou sans structure de corrélation intra-station. Le deuxième modèle dans la table montre que l'ajout d'effet aléatoire sur l'ordonée à l'orgine est significative pour tout niveau de alpha raisonnable. 

```{r}

mod_dens_3 <- lme(dur ~ density + wkend + nb_stations, random = ~1|station,data = dat)
mod_dens_4 <- lme(dur ~  density + wkend + nb_stations, random = ~1|station ,correlation = corCompSymm(form = ~ 1|station), data = dat)

anova(mod_dens_3,mod_dens_4, type = 'LR')

```

Dans la table de régression ci-dessous on peut voir l'effet de la densité qui affecte en moyenne positivement la durée de déplacement en minutes, même chose concernant la fin de semaine. On peut voir que la différence entre la fin de semaine et la semaine est d'en moyenne 13 minutes de déplacements. Cependant, la structure de corrélation d'équicorrélation intra station donne un rho extrêmement petit, il est à se demander si c'est la bonne structure de corrélation à utiliser où même s'il y a une structure de corrélation intra station. 

```{r}
summary(mod_dens_4)
```

## Modèles avec intéraction avec effets aléatoires sur les variables explicatives
Nous allons maintenant ajouter aussi des effets aléatoires sur les différentes variables explicatives. En effet, il est possible qu'il y aille un effet différent de la fin de semaine sur la durée des déplacements dépendamment de la station, nous pouvons penser par exemple à des stations qui serait géographiquement mieux placés ou moins bien placés que d'autres par rapport à des activités que les gens font plus la fin de semaine comme des cinémas, des bars, etc. Par exemple, une station très éloignées des attraits de fin de semaine pourrait résulter à des trajets plus long.

Dans la même ordre d'idée, il serait aussi possible qu'il aille un effet différent d'être membre ou non sur la durée des déplacements d'après la station. Par exemple, puisque le fait d'être membre est avantageux par rapport à la durée du déplacement, il est plus avantageux pour un membre qui utilise une station plus éloignées d'attraits populaires que pour un non-membre de faire d'utiliser le bixi pour un long déplacement vers un attrait. Le membre pourrait ainsi utiliser le bixi pour des déplacements plus loin/long qu'un non-membre habitant près de la même station de bixis.

Nous allons donc développer et comparer deux modèles incluant un effet aléatoire sur l'ordonnée à l'origine et:
1- Avec effets aléatoires sur `wkend` seulement (mod3);
2- Avec effets aléatoires sur `mem` seulement (mod4);
Avec un modèle incluant seulement un effet aléatoire avec l'ordonnée à l'origine.

Les tableaux ci-dessous effectue cette comparaison:
```{r}
mod3 <- lme(dur ~ mem + wkend*mem + arrond*mem, random = ~1 + wkend | station, data = dat)
mod4 <- lme(dur ~ mem + wkend*mem + arrond*mem, random = ~1 + mem | station, data = dat)
```

```{r}
anova(mod1,mod3)
anova(mod1,mod4)
```
Pour les deux modèles, on obtient une valeur de p très petite et une valeur de L.Ratio de -- et --- pour le modèle 3 et 4 respectivement. Ce qui veut dire que nous pouvons rejeter H0 et conclure que les modèles avec effets aléatoires sur les variables explicatives est significativement différent à tout niveau de alpha raisonnable par rapport au modèle avec seulement un effet aléatoire sur l'ordonnée à l'origine.

Dans ces modèles, nous avons poser les effets aléatoires comme étant corrélés. Cependant, il se peut que ces effets soient indépendants. Nous allons donc développer un modèle qui considère ces effets aléatoires indépendants (mod3a et mod4a) et les comparer avec les deux modèles ci-dessus (mod3 et mod4).

```{r}
mod3a <- lme(dur ~ mem + wkend*mem + arrond*mem, random = list(station = pdDiag(~1 + wkend)), data = dat)
mod4a <- lme(dur ~ mem + wkend*mem + arrond*mem, random = list(station = pdDiag(~1 + mem)), data = dat)

anova(mod3,mod3a, type = "LR")
anova(mod4,mod4a, type = "LR")
```
Nous remarquons que L.Ratio = __ et p-value = __ pour le modèle 3a et L.Ratio = __ et p-value = __ pour le modèle 4a. Dans les deux cas, nous rejetons l'hypothèse H0 et pouvons conclure que ces modèles sont significativement différents que leur modèles avec des effets aléatoires corrélées avec un niveau d'alpha de 0.01.



rejeter $H_0$ et conclure que la corrélation entre les effets aléatoires est nécessaire (aussi supporté par le BIC et le AIC).

Nous allons ainsi comparer `mod_fest_2a` avec `mod_fest_2` pour voir s'il est nécessaire de rajouter des effets aléatoires pour la variable `festival`. Cette fois-ci nous allons les comparer avec AIC et BIC, car c'est un test non-standard.

```{r}
anova(mod_fest_2, mod_fest_2a, type = "LR")
```

Comme il est possible de le voir, AIC et BIC est légérement plus petit pour le modèle avec effets aléatoires pour la variable explicative. Ainsi, nous allons garder ce modèle et le comparer à un modèle linéaire.


# Contributions des membres
