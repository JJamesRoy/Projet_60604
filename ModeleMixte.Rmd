---
title: "Projet BIXI - Partie 4: Modèle linéaire mixte"
subtitle: "MATH60604 - Modélisation statistique"
author: "Abdoul Wassi Badirou, Alfred Assal, James Roy, Samuel Croteau"
date: "`r Sys.Date()`"
geometry: margin=1.5cm
output:
  # bookdown::html_document2:
  #   toc: yes
  #   number_sections: yes
  #   toc_float:
  #     collapsed: no
  # #   toc_depth: '3'
  bookdown::pdf_document2:
    toc: yes
    toc_depth: 1
    extra_dependencies: ["flafter"]
params:
  created_date: "2023-09-12"
header-includes:
#- \usepackage{tikz}
#- \usepackage{subcaption}
#- \usepackage{graphicx}
#- \usepackage{sidecap}
- \usepackage{float}
- \usepackage{amsmath}
- \usepackage{ragged2e}
#- \floatplacement{figure}{H}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE,message = FALSE,warning = FALSE,error = TRUE, fig.pos = "H")
```

```{r lib}
library(tidyverse)
library(readxl)
library(knitr)
library(googleway)
library(ggplot2)
library(car)
library(cleandata)
library(data.table)
library(kableExtra)
library(gridExtra)
library(jtools)
library(descr)
library(MASS)
library(emmeans)
library(nlme)
library(stringr)
```

```{r read}
dat = read.csv("dat_full_m.csv")
```

# Introduction

# Impact des festivals

```{r}
festivals <- data.frame(
  Start_Date = as.Date(c("2021-05-10", "2021-05-22", "2021-05-27", "2021-06-06", "2021-06-07",
                         "2021-06-07", "2021-06-07", "2021-06-11", "2021-06-13", "2021-06-14",
                         "2021-06-20", "2021-06-26", "2021-06-27", "2021-06-29", "2021-07-04",
                         "2021-07-05", "2021-07-06", "2021-07-09", "2021-07-10",
                         "2021-07-11", "2021-07-11", "2021-07-22", "2021-07-27", "2021-07-28",
                         "2021-08-02", "2021-08-06", "2021-08-07", "2021-08-08", "2021-08-09",
                         "2021-08-09", "2021-08-19", "2021-08-20", "2021-08-29", "2021-08-30")),
  End_Date = as.Date(c("2021-05-17", "2021-06-04", "2021-06-16", "2021-06-16", "2021-06-09",
                       "2021-06-16", "2021-06-09", "2021-06-16", "2021-06-16", "2021-06-22",
                       "2021-06-23", "2021-06-30", "2021-07-06", "2021-07-27", "2021-07-14",
                       "2021-07-07", "2021-07-06", "2021-07-14", "2021-07-21", "2021-07-28",
                       "2021-07-27", "2021-08-01", "2021-07-28", "2021-07-28", "2021-08-04",
                       "2021-08-14", "2021-08-11", "2021-08-18", "2021-08-10", "2021-08-18",
                       "2021-08-24", "2021-08-25", "2021-09-02", "2021-09-02"))
)

dates <- festivals %>%
  rowwise() %>%
  mutate(Date = list(seq(Start_Date, End_Date, by = "day"))) %>%
  unnest(Date)

result_df <- dates %>%
  group_by(Date) %>%
  summarize(festival = n())

dat$Date <- as.Date(paste("2021", dat$mm, dat$dd, sep = "-"))

dat <- dat %>%
  left_join(result_df, by = "Date")

dat$festival[is.na(dat$festival)] = 0

dat$log_n_tot = log(dat$n_tot)
```

Dans cette section, nous allons nous intéresser à la même question que dans la deuxième partie du travail, soit analyser si les festivals tenus dans la ville de Montréal ont un impact sur l'utilisation des Bixi.

Pour tester cette question, nous allons nous baser sur les données utilisées dans les parties précédentes. Il est cependant utile de respécifier comment la variable `festival`est construite. Celle-ci est une variable de décompte qui note le nombre de festivals ayant lieu cette journée. Ainsi, elle est fixe peu importe la station, tant que la journée est pareille. La variable peut prendre la valeur de 0 à 6.

En addition à un modèle de régression linéaire, comme utilisé lors de la deuxième partie, nous allons tester les effets des festivals en permettant une corrélation intra-station.

## Modèle de régression linéaire

```{r, out.height = "30%"}
mod_fest = gls(log_n_tot ~ festival + mm + holiday + wkend, data = dat)
summary(mod_fest)
```

Avec un modèle linéaire simple, la tenue de festival semble avoir un effet positif et significatif sur le nombre total de déplacements. En effet, un festival de plus par jour augmente en moyenne le nombre total de déplacement de 5% par jour par stations (toutes choses étant égales par ailleurs). De plus, cette augmentation est significatif à tout niveau de alpha raisonnable.

## Modèle avec effets aléatoires

```{r}
mod_fest_2 <- lme(n_tot ~ festival + mm + holiday + wkend, random = ~1 | station,
data = dat)
summary(mod_fest_2)
```

```{r}
mod_fest_2a <- lme(n_tot ~ festival + mm + holiday + wkend, random = ~1 + festival |
station, data = dat)
summary(mod_fest_2a)
```

```{r}
getVarCov(mod_fest_2a, type = "random.effects")
```

```{r}
mod_fest_2b <- lme(n_tot ~ festival + mm + holiday + wkend, random = list(station = pdDiag(~1 + festival)), data = dat)
summary(mod_fest_2b)
```

```{r}
getVarCov(mod_fest_2b, type = "random.effects")
```

```{r}
anova(mod_fest_2, mod_fest_2a, mod_fest_2b, type = "LR")
```
# Impact de la densité de population
Précédemment nous avions étudié l’effet de la densité de population sur le nombre total de déplacements. Cependant, puisque le nombre total de déplacements est une variable de dénombrement, il est plus convenable d’utiliser un modèle linéaire généralisé. Néanmoins, puisque nos connaissances actuelles des modèles mixtes se limitent au cas des régressions linéaires. Nous avons décidé d’étudier une variable réponse différente. Dans ce cas, nous choisissons d’étudier l’effet de la densité de population sur la durée de déplacement totale. À cet égard, la densité de population est calculée de la même façon que dans la seconde partie du travail, soit la population totale par arrondissement par rapport à la superficie de l’arrondissement même. Ainsi, nous avons ajouté les données d’arrondissement selon les stations tout en y incluant la population totale et la superficie de chaque arrondissement.

Dans un premier temps, il faut noter que puisque la densité de population est un effet d’arrondissement, les résultats obtenus nous donneront des effets fixes inter-arrondissement. Pour essayer d’isoler l’effet de la variabilité de la densité de population par arrondissement, lorsque toutes les autres variables restent fixes, il est raisonnable de se dire qu’en ajoutant des effets fixes inter-arrondissement qu’on soit capable d’isoler en partie l’effet fixe de la densité sur la durée de déplacement par arrondissement. 

Dans un second temps, chaque arrondissement contient plusieurs stations. En d’autres termes, on peut assumer qu’il risque d’y avoir une corrélation intra-station, comme expliqué dans les sections précédentes. Cette corrélation a pour effet de biaiser les tests d’hypothèse qu’on a abordés dans la deuxième partie du travail. Autrement dit, en plus d’avoir des effets de groupe inter arrondissement nous nous retrouvons avec des effets de station intra arrondissement, ce qui est problématique dans un cas d’inférence. Pour aborder cette problématique, nous allons utiliser une approche à effets aléatoire, nous permettant ainsi de ne pas utiliser une pléthore de variable explicative pour contrôler les effets fixes de chaque arrondissement tout en considérant la corrélation intra station. 

```{r}
selected_columns <- dat[c("station", "density")]

```


# Contributions des membres
