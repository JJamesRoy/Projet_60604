---
title: "Projet BIXI - Partie 2: Modèle de régression linéaire"
subtitle: "MATH60604 - Modélisation statistique"
author: "Abdoul Wassi Badirou, Alfred Assal, James Roy, Samuel Croteau"
date: "`r Sys.Date()`"
output:
  # pdf_document:
  #   toc: yes
  #   toc_depth: '3'
  bookdown::html_document2:
    toc: yes
    number_sections: yes
    toc_float:
      collapsed: no
  bookdown::pdf_document2:
    toc: yes
    toc_depth: 3
    extra_dependencies: flafter
params:
  created_date: "2023-09-12"
header-includes:
- \usepackage{tikz}
- \usepackage{subcaption}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE,message = FALSE,warning = FALSE,error = TRUE, fig.pos = "H")
```

```{r lib}
library(tidyverse)
library(readxl)
library(knitr)
library(googleway)
library(ggplot2)
library(car)
library(cleandata)
library(data.table)
```

# Note

Question : Comment maximiser les déplacements en Bixi pour accélérer la transition vers une économie verte et réduire l'impact sur l'environnement des moyens de transports.

Sous question :  
- Impact de l'événementiel (James)

- Est-ce que la densité de population du quartier a un impact sur l'utilisation des Bixi (Alfred)

- Attraits touristiques (https://donnees.montreal.ca/dataset/installations-recreatives-sportives-et-culturelles/resource/1c239e86-8b36-476c-bd51-91a3cd20f687) (https://donnees.montreal.ca/dataset/lieux-d-interet/resource/edce22aa-f7cc-495e-9c53-b367f68309f6) (Abdoul)

- Parc (https://donnees.montreal.ca/dataset/grands-parcs-parcs-d-arrondissements-et-espaces-publics) (Sam)


Leviers de Bixi : Publicité et marketing sur le service et l'abonnement. Programme incitation Bixi (alléger les stations ou remplir)

Variables cibles : n_tot et dur

Variables à ajouter : merge avec les autres données par sous-question

# Introduction
- Déterminer les éléments qui influencent l'utilisation des bixi (nombre de déplacement) afin de proposer des stratégies qui permettraient de mieux la démocratiser.

- Déterminer le prix d'imputation des usagers membres qui permettrait de générer un revenu équivalent à celui des non-membres.

# Enrichissement des données

```{r read}
dat = read.csv("bixifull.csv")
```

```{r festival}
festivals <- data.frame(
  Start_Date = as.Date(c("2021-05-10", "2021-05-22", "2021-05-27", "2021-06-06", "2021-06-07",
                         "2021-06-07", "2021-06-07", "2021-06-11", "2021-06-13", "2021-06-14",
                         "2021-06-20", "2021-06-26", "2021-06-27", "2021-06-29", "2021-07-04",
                         "2021-07-05", "2021-07-06", "2021-07-09", "2021-07-10",
                         "2021-07-11", "2021-07-11", "2021-07-22", "2021-07-27", "2021-07-28",
                         "2021-08-02", "2021-08-06", "2021-08-07", "2021-08-08", "2021-08-09",
                         "2021-08-09", "2021-08-19", "2021-08-20", "2021-08-29", "2021-08-30")),
  End_Date = as.Date(c("2021-05-17", "2021-06-04", "2021-06-16", "2021-06-16", "2021-06-09",
                       "2021-06-16", "2021-06-09", "2021-06-16", "2021-06-16", "2021-06-22",
                       "2021-06-23", "2021-06-30", "2021-07-06", "2021-07-27", "2021-07-14",
                       "2021-07-07", "2021-07-06", "2021-07-14", "2021-07-21", "2021-07-28",
                       "2021-07-27", "2021-08-01", "2021-07-28", "2021-07-28", "2021-08-04",
                       "2021-08-14", "2021-08-11", "2021-08-18", "2021-08-10", "2021-08-18",
                       "2021-08-24", "2021-08-25", "2021-09-02", "2021-09-02"))
)

dates <- festivals %>%
  rowwise() %>%
  mutate(Date = list(seq(Start_Date, End_Date, by = "day"))) %>%
  unnest(Date)

result_df <- dates %>%
  group_by(Date) %>%
  summarize(festival = n())

dat$Date <- as.Date(paste("2021", dat$mm, dat$dd, sep = "-"))

dat <- dat %>%
  left_join(result_df, by = "Date")

dat$festival[is.na(dat$festival)] = 0
```

```{r rain}
dat = dat %>% mutate(rain_bin = ifelse(rain == 0, 0, 1)) %>% select(-X)
```

```{r wkend}
dat = dat %>% mutate(wkend = ifelse(wday == "Saturday" | wday == "Sunday",1,0))
col = c("mm", "dd", "mem", "arrond")
dat[col] = lapply(dat[col], factor)
```

```{r dat.mod}
var_mean= c("holiday", "temp", "rain", "festival", "rain_bin", "wkend")
var_sum = c("dur", "rev", "n_tot", "n_AM", "n_PM", "avg")

dat_mod = dat %>% select(-station, -name, -wday, -Date) %>% 
  group_by(mem, mm, dd, arrond) %>%
  summarise(across(all_of(var_mean), ~mean(., na.rm = TRUE)),
            across(all_of(var_sum), ~sum(., na.rm = TRUE))) # Sert à compiler les données selon les arrondissements par jour. On se débarasse ainsi des variables station. Cela fait qu'on peut analyser les données par arrondissement plutot que par station.

dat_mod = as.data.frame(dat_mod)

col = c("holiday", "wkend", "rain_bin")
dat_mod[col] = lapply(dat_mod[col], factor)
```
```{r, results='hide'}
dat_mod
```

## Enrichissement avec les arrondissements des stations {.unnumbered}
```{r importData, results='hide'}
bixi_raw_data_df = read.csv("bixi1.csv", sep=",", header = T)
head(bixi_raw_data_df)
```
```{r importMergeStationNameAndCoord, results='hide'}
# Importation des données de stations: Nom, latitude et Longitude
stations_raw_data_df=read.csv("2021_stations.csv", sep = ",", header = T, encoding='latin_1')
head(stations_raw_data_df)

#Jointure aux données bixi
bixi_with_name_df=merge(bixi_raw_data_df,stations_raw_data_df, by.x = "station",by.y = "pk", all.x = T, all.y = F)
head(bixi_with_name_df)
str(bixi_with_name_df)
```
```{r , results='hide'}
# Validons qu'il n'y a pas de données manquantes suite à l'ajout des noms des stations et leur coordonnées géographique
summary(bixi_with_name_df)
```
```{r, results='hide'}
#Importation des données de stations: Nom, arrondissement, latitude, longitude
bixi_stations_df=read.csv("bixi_stations_full.csv", sep = ",", header = T, encoding='latin_1')
bixi_stations_df$STATIONARRONDISSEMENT[bixi_stations_df$STATIONARRONDISSEMENT=="Mont-Royal"]="Le Plateau-Mont-Royal"
# bixi_stations_df$STATIONARRONDISSEMENT[bixi_stations_df$STATIONARRONDISSEMENT=="Côte-des-Neiges - Notre-Dame-de-Grâce"]="Côte-des-Neiges-Notre-Dame-de-Grâce"
# bixi_stations_df$STATIONARRONDISSEMENT[bixi_stations_df$STATIONARRONDISSEMENT=="Mercier - Hochelaga-Maisonneuve"]="Mercier-Hochelaga-Maisonneuve"
# bixi_stations_df$STATIONARRONDISSEMENT[bixi_stations_df$STATIONARRONDISSEMENT=="Rosemont - La Petite-Patrie"]="Rosemont-La Petite-Patrie"
# bixi_stations_df$STATIONARRONDISSEMENT[bixi_stations_df$STATIONARRONDISSEMENT=="Rivière-des-Prairies - Pointe-aux-Trembles"]="Rivière-des-Prairies–Pointe-aux-Trembles"
# bixi_stations_df$STATIONARRONDISSEMENT[bixi_stations_df$STATIONARRONDISSEMENT=="Villeray - Saint-Michel - Parc-Extension"]="Villeray–Saint-Michel–Parc-Extension"
head(bixi_stations_df)

# merge pour inclure les arrondissements
bixi_with_arrond_df=merge(bixi_with_name_df,bixi_stations_df, by.x = 'name',by.y = 'STATIONNAME', all.x = T, all.y = F)
head(bixi_with_arrond_df)
```
```{r, include=FALSE}
#write.csv(bixi_stations_df,file="bixi_stations_full2.csv",sep = ",", row.names = F) 
```

```{r, results='hide'}
summary(bixi_with_arrond_df)
```
```{r, results='hide'}
bixiWithArron_clean_df=data.frame(name=bixi_with_arrond_df$name,latitude=bixi_with_arrond_df$latitude,
      longitude=bixi_with_arrond_df$longitude,arrondissement=bixi_with_arrond_df$STATIONARRONDISSEMENT,
      bixi_with_arrond_df[,names(bixi_raw_data_df)])
bixiWithArron_clean_df
```


# Transformation variables d'intérêts

Nous allons observer nos variables d'intérêts pour voir si elles se prêtent à l'analyse statistique.

```{r histn, out.height = "30%", fig.cap="Distribution des déplacements totaux", fig.align='center'}
hist(dat_mod$n_tot, 
     ylab = "Fréquence", 
     xlab = "Nombre de déplacement totaux",
     main = "")
```

Dans la \@ref(fig:histn), on voit que les données de la variable `n_tot` ne sont pas normales, il faudrait les normaliser pour être capable de faire des analyses statistiques à l'aide de régression linéaire.

```{r histn2, out.height = "30%", fig.cap="Distribution du log des déplacements totaux", fig.align='center'}
dat_mod = dat_mod %>% mutate(n_tot_mod = log(n_tot))
hist(dat_mod$n_tot_mo, 
     ylab = "Fréquence", 
     xlab = "Nombre de déplacement totaux",
     main = "")
```

Maintenant, dans la \@ref(fig:histn2), on voit qu'avec une transformation logarithmique, les données se normalisent. Par contre, le côté gauche de la courbe est encore relevé, cela peut impacter l'inférence statistique que nous allons faire prochainement.

# Analyse de multicolinéarité
À faire si on a le temps.
Les variables que nous savons qui ont une colinéarité parfaite:

- `avg` et `dur` puisque avg=dur/n_tot
- `rev` et `dur` puisque rev=alpha*dur
- valider pour `mm`, `dd` et `wday`. Si ce n'est pas lié vérifier si ce n'est pas à cause du fait que nous avons un sous-ensemble aléatoire

# Impact des lieux touristiques
Dans cette section, nous voulons analyser l'impact de la présence des lieux touristiques sur l'utilisation des Bixi. Pour cela, nous utilisons le jeu de données sur les lieux d'intérêt disponible dans les données ouvertes de la ville de montréal à l'adresse url https://donnees.montreal.ca/dataset/lieux-d-interet. Nous calculons le nombre de sites touristiques par arrondissement que nous fusionnons à nos données `bixi`. 
<!-- Nous agrégeons ces données par arrondissement pour les fusionner à nos données bixi. À partir de ces données, nous créons deux variables:  
- `lieuxTouristiques` (1 ou 0): indique s'il y a un lieu touristique dans l'arrondissement (1) ou non (0)
- `n_touristiques`: nombre de lieux touristiques dans l'arrondissement. -->
Nous considérons comme lieux touristiques, les sites qui sont dans les catégories `Établissement culturel`, `Bâtiment et lieu d'intérêt`, `Art public`, `Circuit et parcours`, `Attrait touristique`, `Lieu de diffusion` et `Centre de congrès / d'exposition`. Les données pour les arrondissements de `longueuil` et `laval` sont tirés respectivement de https://www.donneesquebec.ca/recherche/dataset/installations et https://www.donneesquebec.ca/recherche/dataset/sites-de-loisirs
```{r, results='hide'}
#Import lieux intérêts montréal
mtl_lieuxInterets_raw_data_df=read.csv("lieux_d_interet.csv", sep = ",", header = T)
mtl_lieuxInterets_raw_data_df

#Import lieux intérêts longueuil
longueuil_lieuxInterets_raw_data_df=read.csv("installations_longueuil_riche.csv", sep=",", header = T, encoding = 'latin_1')
longueuil_lieuxInterets_raw_data_df

#Import lieux intérêts laval
laval_lieuxInterets_raw_data_df=read.csv("sites-de-loisirs_laval.csv", sep=",", header = T)
laval_lieuxInterets_raw_data_df
```
```{r, results='hide'}
#Montréal: Nombre de site par arrondissement
cat_lieux_touristique=c("Établissement culturel","Bâtiment et lieu d'intérêt","Art public","Circuit et parcours","Attrait touristique","Lieu de diffusion","Centre de congrès / d'exposition")
mtl_lieuxInterets_df=mtl_lieuxInterets_raw_data_df[mtl_lieuxInterets_raw_data_df$Catégorie %in% cat_lieux_touristique,]
nb_sitesTouristiques_by_arrondissement <- mtl_lieuxInterets_df %>% 
  group_by(Arrondissement) %>%
  summarise(nb_tour=n())

#On ajuste le nom des arrondissements pour s'aligner avec ceux dans nos données bixi
nb_sitesTouristiques_by_arrondissement$Arrondissement[nb_sitesTouristiques_by_arrondissement$Arrondissement=="Côte-des-Neiges–Notre-Dame-de-Grâce"]="Côte-des-Neiges - Notre-Dame-de-Grâce"
nb_sitesTouristiques_by_arrondissement$Arrondissement[nb_sitesTouristiques_by_arrondissement$Arrondissement=="Mercier–Hochelaga-Maisonneuve"]="Mercier - Hochelaga-Maisonneuve"
#nb_sitesTouristiques_by_arrondissement$Arrondissement[nb_sitesTouristiques_by_arrondissement$Arrondissement=="Le Plateau-Mont-Royal"]="Mont-Royal"
nb_sitesTouristiques_by_arrondissement$Arrondissement[nb_sitesTouristiques_by_arrondissement$Arrondissement=="Rivière-des-Prairies–Pointe-aux-Trembles"]="Rivière-des-Prairies - Pointe-aux-Trembles"
nb_sitesTouristiques_by_arrondissement$Arrondissement[nb_sitesTouristiques_by_arrondissement$Arrondissement=="Rosemont–La Petite-Patrie"]="Rosemont - La Petite-Patrie"
nb_sitesTouristiques_by_arrondissement$Arrondissement[nb_sitesTouristiques_by_arrondissement$Arrondissement=="Villeray–Saint-Michel–Parc-Extension"]="Villeray - Saint-Michel - Parc-Extension"
nb_sitesTouristiques_by_arrondissement$Arrondissement[nb_sitesTouristiques_by_arrondissement$Arrondissement=="Ville de Westmount"]="Westmount"

#Longueuil: Nombre de site par arrondissement
longueuil_lieuxInterets_df=longueuil_lieuxInterets_raw_data_df[longueuil_lieuxInterets_raw_data_df$ARRONDISSEMENT=="Arrondissement du Vieux-Longueuil" & longueuil_lieuxInterets_raw_data_df$Catégorie=="Tourisme",]
longueuil_nb_tour=nrow(longueuil_lieuxInterets_df)
nb_sitesTouristiques_by_arrondissement=rbind(nb_sitesTouristiques_by_arrondissement,
          data.frame(Arrondissement='Longueuil',nb_tour=longueuil_nb_tour))

#Laval: Nombre de site par arrondissement
cat_lieux_touristique_laval=c("Aréna","Salle de spectacle","Centre de création / Espace de diffusion","Centre sportif")
laval_lieuxInterets_df=laval_lieuxInterets_raw_data_df[laval_lieuxInterets_raw_data_df$descr_type_site %in% cat_lieux_touristique_laval,]
laval_nb_tour=nrow(laval_lieuxInterets_df)
nb_sitesTouristiques_by_arrondissement=rbind(nb_sitesTouristiques_by_arrondissement,
          data.frame(Arrondissement='Laval',nb_tour=laval_nb_tour))

nb_sitesTouristiques_by_arrondissement

#Merge avec les données bixi
bixi_df=merge(bixiWithArron_clean_df,nb_sitesTouristiques_by_arrondissement,by.x = 'arrondissement',by.y = 'Arrondissement', all.x = T, all.y = F)
bixi_df$wday <- as.factor(bixi_df$wday)
bixi_df$mem <- as.factor(bixi_df$mem)
bixi_df
```
```{r, results='hide'}
bixi_df[is.na(bixi_df$nb_tour),]
```

Étant donné que plusieurs satitions bixi se retrouvent dans un arrondissement, pour évaluer l'impact du nombre de sites touristiques par arrondissement sur l'utilisation des bixi, nous agrégeons nos données par arrondissement, par jour et par type de membre, en prenant la moyenne des différentes variables bixi par arrondissement. Ainsi, nous analysons l'impact des sites touristiques par arrondissement, sur l'utilisation moyenne dans l'arrondissement. Cette dernière est le rapport entre le nombre total de déplacement dans l'arrondissement et le nombre de station qui s'y retrouve. 
Rapellons que notre variable cible est le logarithme du nombre total de déplacement (`n_tot_log)

```{r, results='hide', fig.keep='none'}
#Scatter plot pour voir à quoi ressemble la relation entre le nombre de sites par arrondissement et log(n_tot) si on n'agrège pas les données par arrondissement
ggplot(bixi_df, aes(x=nb_tour, y=log(n_tot))) + geom_point() + geom_smooth(method='lm')
```
```{r, results='hide'}
# Agrégation des données par arrondissement
var_agg=c("dur","rev","n_AM","n_PM","n_tot","temp","rain","nb_tour")
var_agg_rename=var_agg[var_agg != "nb_tour"]
bixi_agg_arrond_df <- bixi_df %>% 
  group_by(arrondissement, mm,dd,wday,mem,holiday) %>%
  summarise(across(var_agg, mean))
bixi_agg_arrond_df=as.data.frame(bixi_agg_arrond_df)
setnames(bixi_agg_arrond_df,old = var_agg_rename, new = paste0('avg_',var_agg_rename))
bixi_agg_arrond_df$arrondissement <- as.factor(bixi_agg_arrond_df$arrondissement)
bixi_agg_arrond_df
```

```{r, results='hide'}
#tapply(bixi_agg_arrond_df$arrondissement,as.factor(bixi_agg_arrond_df$nb_tour), n_distinct)
```

```{r}
#ggplot(bixi_agg_arrond_df, aes(x=nb_tour, y=log(n_tot))) + geom_point() + geom_smooth(method='lm')
mod1 <- lm(log(avg_n_tot) ~ nb_tour, data=bixi_agg_arrond_df)
summary(mod1)
```

Lorsqu'on tient compte uniquement du nombre de site touristique par arrondissement, on constate que pour chaque augmentation d'une unité de cette dernière, en moyenne, le nombre total de déplacement par station, par jour et par type de membre augmente de `r round((exp(mod1$coefficients['nb_tour'])-1)*100,2)`%. Et cette augmentation est significative. Qu'en-est-il lorsqu'on tient compte des autres variables.

Tout d'abord, il est important de décrire notre modèle complet. Il est composé de toutes les variables sauf `station`, `arrondissement`, `rev`, `dur`, `avg` et `n_PM`. 
La variable `station` qui est l'identification unique des stations, est exclue car elle ne comporte aucune codification. Donc elle n'apporte aucune information. De plus, comme nous avons agrégé les données à l'arrondissement, la variable n'est plus du tout pertinente. 

La variable `arrondissement` est exclue car elle a une corrélation très forte avec `nb_tour` (nombre de sites touristiques dans la station). L'ajustement d'un modèle qui inclus ces deux variables retourne `NA` pour l'un deux. Elle s'explique par le fait que quasiment tous les arrondissements ont des nombres de sites différents. Donc quasiment, chaque nombre de site correspond à un arrondissement différent. 

Les variables `rev` et `dur` (durée totale de tous les déplacements partant de la station au jour spécifié) sont exclues car ceux sont des variables cibles dans le cadre du projet. Or dans cette section on s'intéresse à l'impact sur la variable `n_tot`. 

La variable `avg` (la durée moyenne (en minutes) de tous les déplacement partant d'une station au jour spécifié) est exclue car elle perd son sens suite à l'agrégat `moyenne` utilisée sur les variables pour agréger les données par arrondissement. Rappelons que pour agréger les données, nous calculons pour les variables leur moyenne sur l'ensemble des stations dans l'arrondissement. Soit $S$ l'ensemble des stations, indexé par $i$. Soit $A$ l'ensemble des arrondissements, indexé par $j$. Soit: 

- $\overline{N}_j$: la moyenne du nombre total de déplacements par station dans l'arrondissement $j$

- $\overline{D}_j$: la moyenne de la durée totale des déplacements par station dans l'arrondissement $j$

- $\overline{A}_j$: la moyenne de la durée moyenne des déplacement par station dans l'arrondissement $j$

\begin{equation} 
 \overline{N}_j = \sum_{i=1}^{S} \frac{N_{i,j}}{S}=\sum_{i=1}^{S} \frac{D_{i,j}A_{i,j}}{S} \ne \sum_{i=1}^{S} \frac{D_{i,j}}{S}\sum\frac{A_{i,j}}{S} (\#eq:relationDurAvg)
\end{equation}

La relation décrite par l'équation \@ref(eq:relationDurAvg) décrit mathématiquement la raison pour laquelle nous excluons la variable `avg` dans les données agrégées. 

La variable `n_PM` est exclue car elle a une forte corrélation avec `n_AM`.

```{r ModLieuTouristiqueAjustementModComplet}
mod2 <- lm(log(avg_n_tot) ~ mm + dd + wday+ mem + holiday + avg_n_AM + avg_temp + avg_rain + nb_tour, data=bixi_agg_arrond_df)
summary(mod2)
```

Même après avoir ajusté pour les autres variables, on constate que le nombre de site touristique a un effet significatif sur le nombre total de déplacement par station par arrondissement pour n'importe quel niveau de significance aceptable. En fait, pour chaque augmentation d'un site touristique dans un arrondissement, en moyenne, le nombre total de déplacement par station, par jour et par type de membre augmente de `r round((exp(mod2$coefficients['nb_tour'])-1)*100,2)`% lorsque les autres variables restent inchangés.  

De plus, l'impact des membres bixi sur le nombre total de trajet par station par arrondissement est `r round(exp(mod2$coefficients['mem1']),2)` fois plus important que celui des non membres toujours lorsque les autres variables restent inchangés. Et cet impact est aussi significatif. 

Une entente avec les villes pour construire d'avantage de lieux touristiques pourrait permettre d'accroitre l'utilisation des bixi. De plus, puisque les membres semblent avoir un impact plus important sur l'utilisation des bixi que les non-membres, une stratégie visant à accroitre le portefeuille de client membre serait avantageux.

Quel genre d'interaction on peut regarder?????
```{r}
#bixi_agg_arrond_df
```


```{r, results='hide'}
bixi_df2=bixi_df
bixi_df2$wday=as.integer(encode_ordinal(bixi_df["wday"], order= c('Monday','Tuesday','Wednesday','Thursday','Friday','Saturday','Sunday'))$wday)
bixi_df2
#ord_wday=encode_ordinal(bixi_df["wday"], order= c('Monday','Tuesday','Wednesday','Thursday','Friday','Saturday','Sunday'))
#ord_wday
fiv_mod = lm(mm ~ dd + wday, data=bixi_df2)
summary(fiv_mod)

```
```{r, results='hide'}
vif(fiv_mod)
```


# Parc

Données utilisées: <https://donnees.montreal.ca/dataset/installations-recreatives-sportives-et-culturelles/resource/1c239e86-8b36-476c-bd51-91a3cd20f687> <https://donnees.montreal.ca/dataset/grands-parcs-parcs-d-arrondissements-et-espaces-publics> <https://donnees.montreal.ca/dataset/lieux-culturels>

```{r}
#get data
data_parc <- read.csv("espace_vert.csv")
data_es <- read.csv("terrain_sport_ext.csv")
data_lc <- read_excel("lieuxculturels.xls")


#Parcs
nb_arrond_parc <- (table(data_parc$GESTION))
dat_nb_parc <- data.frame(arrond = names(nb_arrond_parc), nb_parc = as.numeric(nb_arrond_parc))
dat_parc <- dat %>%
  select(dur, n_tot, rev, arrond) %>% 
  group_by(arrond) %>%
  summarise(dur = (sum(dur)))
dat_nb_parc$arrond <- tolower(gsub("\\s+", "", dat_nb_parc$arrond))
dat_nb_parc$arrond<-gsub("-", "", dat_nb_parc$arrond)
dat_parc$arrond <- tolower(gsub("\\s+", "", dat_parc$arrond))
dat_parc$arrond<-gsub("-", "", dat_parc$arrond)

df_parc <- merge(dat_parc, dat_nb_parc, by = "arrond", all.x = TRUE)
df_parc$nb_parc <- ifelse(is.na(df_parc$nb_parc), 0, df_parc$nb_parc)

#Espaces sportifs
nb_arrond_es <- table(data_es$ARROND)
dat_nb_es <- data.frame(arrond = names(nb_arrond_es), nb_es = as.numeric(nb_arrond_es))
dat_nb_es$arrond <- tolower(gsub("\\s+", "", dat_nb_es$arrond))
dat_nb_es$arrond<-gsub("-", "", dat_nb_es$arrond)

dat_es <- dat_parc
df_es <- merge(dat_es, dat_nb_es, by = "arrond", all.x = TRUE)

#Lieux culturels
nb_arrond_lc <- table(data_lc$Arrondissement)
dat_nb_lc <- data.frame(arrond = names(nb_arrond_lc), nb_lc = as.numeric(nb_arrond_lc))
dat_nb_lc$arrond <- tolower(gsub("\\s+", "", dat_nb_lc$arrond))
dat_nb_lc$arrond<-gsub("-", "", dat_nb_lc$arrond)
dat_nb_lc$arrond <- gsub("[-–]", "", dat_nb_lc$arrond)

dat_lc <- dat_parc
df_lc <- merge(dat_lc, dat_nb_lc, by = "arrond", all.x = TRUE)


#Modèles vs rev
df_parc_es <- merge(df_parc, dat_nb_es, by = "arrond", all.x = TRUE)
df_parc_es_lc <- merge(df_parc_es, dat_nb_lc, by = "arrond", all.x = TRUE)
df_parc_es_lc <- replace(df_parc_es_lc, is.na(df_parc_es_lc), 0)

modele4 = lm(dur~nb_parc + nb_es + nb_lc, data = df_parc_es_lc)

```

# Modèle avec les festivals

Dans cette section, nous allons analyser si les festivals tenus dans la ville de Montréal ont un impact sur l'utilisation des Bixi. Cette question est intéressante, car elle permet, selon les résultats obtenus, de s'allier avec la ville de Montréal et différente organisations et organismes en lien avec les festivals pour promouvoir un moyen de déplacement moins intensif sur les émission de polluants. Plusieur stratégies d'affaires peuvent être pris selon les résultats. Par exemple : offrir des promotions dans les stations proches des festivals, augmenter la disponibilité des Bixi lors des festivals ou encore promouvoir le service à l'approche des différents festivals.

Pour tester cette question, nous allons produire plusieurs modèles de régression linéaire et faire de l'inférence sur les résultats obtenus. Les données des festivals viennent d'une archive disponible sur ce site web : <https://web.archive.org/web/20210928074344/https://www.mtl.org/fr/experience/guide-des-festivals-dete-montreal> et elles ont été compilées manuellement.

## Modèle linéaire simple

```{r fest1, out.height = "30%"}
mod_fest_1 = lm(n_tot_mod ~ festival, data = dat_mod)
summary(mod_fest_1)
```

Avec un modèle linéaire simple, la tenue de festival semble avoir un effet positif et significatif sur le nombre total de déplacements. En effet, un festival de plus par jour augmente en moyenne le nombre total de déplacement de 3.4% par jour par arrondissement (toutes choses étant égales par ailleurs). De plus, cette augmentation est significatif à un niveau de 95%.

Or, il est important de discuter des limitations d'un tel modèle. Plusieurs autres variables agissent sur le nombre total de déplacements et sur la tenue de festival, il faut ainsi controler pour ces variables. Pour mieux comprendre ce problème, voici un graphe orienté acyclique (GOA) \@ref(fig:firstgroup).

```{=tex}
\begin{figure}[h!]
\caption{\label{fig:firstgroup}}
\centering
\begin{tikzpicture}[->]
\node (X) at (0,0) {$festival$};
\node (Z2) at (1.5,-1) {$Z_1$};
\node (Y) at (3,0) {$n\_tot$};
\path (X) edge (Y);
\path (Z2) edge (X);
\path (Z2) edge (Y);
\end{tikzpicture}
\end{figure}
```
Ainsi, s'il existe des variables $Z_1$ qui affectent à la fois `festival` et `n_tot`, il faut ajouter ces variables dans le modèle pour avoir une estimation plus précises des effets des prédicteurs.

Au niveau de la normalité des résidus, on doit les analyser après la transformation logarithmique.

```{r fest-res1, out.height = "30%", fig.align='center', fig.cap="Distribution des résidus"}
resid <- rstudent(mod_fest_1)
fitted <- mod_fest_1$fitted.values
res.dat <- cbind(dat_mod, fitted, resid)
ggplot(data = res.dat, mapping = aes(x = resid)) + geom_density() +
geom_histogram(aes(y = ..density..), bins = 10, alpha = 0.5) +
xlab("Résidus") +
ylab("Densité")
```

```{r fest-qq1, out.height = "30%", fig.align='center', fig.cap="QQ-Plot Résidus Student"}
ggplot(data = res.dat, mapping = aes(sample = resid)) + stat_qq(distribution = qt,
dparams = mod_fest_1$df.residua) + stat_qq_line(distribution = qt,
dparams = mod_fest_1$df.residual) + labs(x = "Quantiles théoriques",
y = "Quantiles empiriques")
```

En observant les figures \@ref(fig:fest-res1) et \@ref(fig:fest-qq1), on voit que les résidus semblent ne pas être normales dans le premier tiers des données. Par la suite, les résidus semblent se rapprocher d'un distribution normale. Or, étant donné que les résidus ne sont pas parfaitement normales, cela va poser des limitations dans l'analyse et l'inférence des résultats.

## Modèle linéaire ajusté

Comme expliqué précédemment, nous devons ajouter des variables dans le modèles pour avoir une estimation plus précise. Il serait utile d'ajouter la variable `holiday`, `mm` et `wkend`. En effet, ces variables agissent à la fois sur `festival` et `n_tot`.

```{r, out.height = "30%"}
mod_fest_2 = lm(n_tot_mod ~ festival + mm + holiday + wkend, data = dat_mod)
summary(mod_fest_2)
```

En controlant pour les variables omises, nous observons maintenant un changement dans l'interprétation des résultats. L'effet des festival semble être négatif et non-significatif. Dans ce modèle, chaque festival diminue le nombre total de déplacement de 2,4% par jour par quartier de façon non-significative. Il semblerait que l'effet passe maintenant par les mois et non par les festivals.

Si nous analysons rapidement les résidus, nous voyons dans les figures \@ref(fig:fest-res2) et \@ref(fig:fest-qq2) qu'ils semblent légèrement plus normales que dans le premier modèle.

```{r fest-res2, out.height = "30%", fig.align='center', fig.cap="Distribution des résidus"}
resid <- rstudent(mod_fest_2)
fitted <- mod_fest_1$fitted.values
res.dat <- cbind(dat_mod, fitted, resid)
ggplot(data = res.dat, mapping = aes(x = resid)) + geom_density() +
geom_histogram(aes(y = ..density..), bins = 10, alpha = 0.5) +
xlab("Résidus") +
ylab("Densité")
```

```{r fest-qq2, out.height = "30%", fig.align='center', fig.cap="QQ-Plot Résidus Student"}
ggplot(data = res.dat, mapping = aes(sample = resid)) + stat_qq(distribution = qt,
dparams = mod_fest_2$df.residua) + stat_qq_line(distribution = qt,
dparams = mod_fest_2$df.residual) + labs(x = "Quantiles théoriques",
y = "Quantiles empiriques")
```

### Modèle avec interaction

Il peut être intéressant de tester un modèle avec interactions étant donné que les utilisations seront peut-être augmenté si un festival est pendant une fin de semaine ou une journée férié.

```{r}
mod_fest_3 = lm(n_tot_mod ~ festival*holiday +festival*wkend +festival + mm + holiday + wkend, data = dat_mod)
summary(mod_fest_3)
```

Or, il ne semble pas avoir d'effets non plus.

### Modèle avec seulement les non-membres

Il serait aussi intéressant de tester si les non-membres (qui ont une utilisation différente des Bixi) utilisent plus les Bixi lors des festivals. Pour cela, nous allons tester le deuxième modèle sur les non-membres seulement.

```{r, out.height = "30%"}
mod_fest_4 = lm(n_tot_mod ~ festival + mm + holiday + wkend, data = dat_mod[dat_mod$mem == 0,])
summary(mod_fest_4)
```

De façon similaire au modèle précédemment, les festivals n'ont pas d'effets significatifs même lorsqu'on regarde seulement les non-membres de Bixi.

## Discussion sur les résultats

Étant donné les résultats des modèles que nous avons fait précédemment, les festivals ne semblent pas avoir d'effets significatifs sur l'utilisation des Bixi que cela soit pour les membres ou les non-membres. Ainsi, nous ne pouvons pas nous prononcer sur des politiques et stratégies que l'entreprise pourrait appliquer.

# Modèles avec la densité

```{r initialisation des données}
library(stringr)
dat_pop <- read.csv("pop_arrondissement.csv")

dat_pop$Superficie <- gsub(",", ".", dat_pop$Superficie)
dat_pop$Superficie <- as.numeric(dat_pop$Superficie)

dat_pop$Population.2021. <- str_replace_all(dat_pop$Population.2021., "\\s", "")
dat_pop$Population.2021. <- as.numeric(dat_pop$Population.2021.)


dat_pop <- dat_pop %>% 
  rename(
    arrond = Nom,
    superficie = Superficie,
    population_2021 = Population.2021.
  )
dat_pop$density <- dat_pop$population_2021/dat_pop$superficie

dat$arrond <- str_replace_all(dat$arrond, " - ", "-")

arrond = c(
    "Villeray-Saint-Michel-Parc-Extension",
    "Ville-Marie",
    "Verdun",
    "Saint-Léonard",
    "Saint-Laurent",
    "Rosemont-La Petite-Patrie",
    "Rivière-des-Prairies-Pointe-aux-Trembles",
    "Pierrefonds-Roxboro",
    "Outremont",
    "Montréal-Nord",
    "Mercier-Hochelaga-Maisonneuve",
    "L'Île-Bizard–Sainte-Geneviève",
    "Le Sud-Ouest",
    "Le Plateau-Mont-Royal",
    "LaSalle",
    "Lachine",
    "Côte-des-Neiges-Notre-Dame-de-Grâce",
    "Anjou",
    "Ahuntsic-Cartierville",
    "Westmount",
    "Mont-Royal",
    "Laval",
    "Longueuil"
  )
dat_pop$arrond <- arrond

dat<- dat %>% left_join(dat_pop)

unique(dat$arrond[is.na(dat$population_2021)])

```

## Modèle linéaire simple

```{r SimpleDensity}

model_density <- lm(n_tot~density ,dat )

summary(model_density)
```

Dans ce modèle de régression linéaire simple, il est possible de constater que la variable de densité est bien significative. Autrement dit, une augmentation d'une personne par kilomètre carré augmenterait en moyenne le nombre total de déplacements de 0.0024. Cependant, la valeur du $R^2$ signifie que le modèle explique 9,4% de la variabilité du nombre total de déplacements. Cela dit, il y a nécessairement un manque de variables explicatives qui permettrait de mieux expliquer la variable réponse.

Dans ce même ordre d'idée, il est possible d'observer si l'hypothèse de normalité des résidus ainsi que l'hypothèse d'homoscédasticité sont respectées dans ce modèle simple, avant d'amorcer un modèle multiple.

```{r QQdensite,out.height = "30%", fig.align='center', fig.cap= "Graphique QQ - modèle de densité démogrphaique simple"}


residuals <- residuals(model_density)


ggplot(data.frame(Résidus = residuals), aes(sample = Résidus)) +
  stat_qq() +
  stat_qq_line() +
  xlab("Quantiles Théoriques") +
  ylab("Quantiles de l'Échantillon") +
  ggtitle("Graphique Q-Q")



```

En examinant le comportement des résidus dans la figure \@ref(fig:QQdensite), il est plausible de dire que les résidus ne suivent pas une loi normale. Cela étant dit, dans le cas de ce modèle simple cela veut dire que la densité comme seule variable explicative explique mal le comportement du nombre total de déplacements en Bixi.


# Conclusion
