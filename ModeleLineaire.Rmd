---
title: "Projet BIXI - Partie 2: Modèle de régression linéaire"
subtitle: "MATH60604 - Modélisation statistique"
author: "Abdoul Wassi Badirou, Alfred Assal, James Roy, Samuel Croteau"
date: "`r Sys.Date()`"
output:
  bookdown::html_document2:
    toc: yes
    number_sections: yes
    toc_float:
      collapsed: no
  #   toc: yes
  #   toc_depth: '3'
  bookdown::pdf_document2:
    toc: yes
    toc_depth: 2
    extra_dependencies: ["flafter"]
  # pdf_document:
params:
  created_date: "2023-09-12"
header-includes:
- \usepackage{tikz}
- \usepackage{subcaption}
# - \usepackage{subfig}
- \usepackage{graphicx}
- \usepackage{sidecap}
- \usepackage{float}
- \usepackage{amsmath}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE,message = FALSE,warning = FALSE,error = TRUE, fig.pos = "H")
```

```{r lib}
library(tidyverse)
library(readxl)
library(knitr)
library(googleway)
library(ggplot2)
library(car)
library(cleandata)
library(data.table)
library(kableExtra)
library(gridExtra)
```


# Introduction

Dans cette deuxième partie du projet, nous devions présenter des modèles de régression linéaire permettant de répondre à une question de sorte à conseiller la compagnie BIXI d'un point de vue d'affaires. D'abord, avant de choisir le sujet du questionnement, on s'est penché sur la compagnie elle-même. Sachant que BIXI est une compagnie à but non lucratif, son but n'est pas nécessairement de maximiser ses profits. C'est ainsi qu'on s'est questionné à savoir, qu'est ce qui intéresserait un OBNL comme BIXI.

Au premier abord, on a conclu que la question devait être plus d'ordre environnemental. Qu'est-ce que la compagnie peut faire pour accélérer la transition vers une économie verte, en réduisant l'impact environnemental des moyens de transport? Bien sûr, cette question est très large, mais elle nous affecte un nouveau problème où l'on s'intéresse moins à la durée des déplacements et plus au nombre de déplacement. Cette réflexion provient du fait, que le nombre de déplacements est en lien avec le nombre d'utilisateurs. Ce qui veut dire qu'un déplacement en Bixi de plus, c'est une personne qui à décider de ne pas prendre sa voiture. À cet égard, on va s'intéresser à plusieurs sous-questions, à savoir comment les évènements affectent le nombre de déplacements. Autrement dit, est-ce que les festivals à Montréal affectent le nombre d'utilisations des Bixi? On va aussi s'intéresser aux portraits démographiques de la ville. À savoir, est-ce que la densité de population, les parcs, les lieux culturels et les autres formes d'infrastructures mises en place dans les villes affectent le nombre d'utilisations des Bixi? Bien sûr, chaque modèle présenté aura ses limites et elles seront toutes abordées en temps et lieu. Toutefois, ces questions peuvent revêtir un intérêt significatif pour la compagnie, car elles offrent la possibilité de cibler les zones où l'utilisation du vélo est plus répandue dans la région métropolitaine de Montréal, tout en explorant les opportunités pour étendre ses services en contribuant à la réduction de l'usage des modes de transport non-écologiques.


<!-- # Enrichissement des données -->
```{r read}
dat = read.csv("bixifull.csv")
```

```{r festival}
festivals <- data.frame(
  Start_Date = as.Date(c("2021-05-10", "2021-05-22", "2021-05-27", "2021-06-06", "2021-06-07",
                         "2021-06-07", "2021-06-07", "2021-06-11", "2021-06-13", "2021-06-14",
                         "2021-06-20", "2021-06-26", "2021-06-27", "2021-06-29", "2021-07-04",
                         "2021-07-05", "2021-07-06", "2021-07-09", "2021-07-10",
                         "2021-07-11", "2021-07-11", "2021-07-22", "2021-07-27", "2021-07-28",
                         "2021-08-02", "2021-08-06", "2021-08-07", "2021-08-08", "2021-08-09",
                         "2021-08-09", "2021-08-19", "2021-08-20", "2021-08-29", "2021-08-30")),
  End_Date = as.Date(c("2021-05-17", "2021-06-04", "2021-06-16", "2021-06-16", "2021-06-09",
                       "2021-06-16", "2021-06-09", "2021-06-16", "2021-06-16", "2021-06-22",
                       "2021-06-23", "2021-06-30", "2021-07-06", "2021-07-27", "2021-07-14",
                       "2021-07-07", "2021-07-06", "2021-07-14", "2021-07-21", "2021-07-28",
                       "2021-07-27", "2021-08-01", "2021-07-28", "2021-07-28", "2021-08-04",
                       "2021-08-14", "2021-08-11", "2021-08-18", "2021-08-10", "2021-08-18",
                       "2021-08-24", "2021-08-25", "2021-09-02", "2021-09-02"))
)

dates <- festivals %>%
  rowwise() %>%
  mutate(Date = list(seq(Start_Date, End_Date, by = "day"))) %>%
  unnest(Date)

result_df <- dates %>%
  group_by(Date) %>%
  summarize(festival = n())

dat$Date <- as.Date(paste("2021", dat$mm, dat$dd, sep = "-"))

dat <- dat %>%
  left_join(result_df, by = "Date")

dat$festival[is.na(dat$festival)] = 0
```

```{r rain}
dat = dat %>% mutate(rain_bin = ifelse(rain == 0, 0, 1)) %>% select(-X)
```

```{r wkend}
dat = dat %>% mutate(wkend = ifelse(wday == "Saturday" | wday == "Sunday",1,0))
col = c("mm", "dd", "mem", "arrond")
dat[col] = lapply(dat[col], factor)
```

```{r dat.mod}
var_mean= c("holiday", "temp", "rain", "festival", "rain_bin", "wkend")
var_sum = c("dur", "rev", "n_tot", "n_AM", "n_PM", "avg")

dat_mod = dat %>% select(-station, -name, -wday, -Date) %>% 
  group_by(mem, mm, dd, arrond) %>%
  summarise(across(all_of(var_mean), ~mean(., na.rm = TRUE)),
            across(all_of(var_sum), ~sum(., na.rm = TRUE))) # Sert à compiler les données selon les arrondissements par jour. On se débarasse ainsi des variables station. Cela fait qu'on peut analyser les données par arrondissement plutot que par station.

dat_mod = as.data.frame(dat_mod)

col = c("holiday", "wkend", "rain_bin")
dat_mod[col] = lapply(dat_mod[col], factor)
```
```{r, results='hide'}
dat_mod
```

<!-- ## Enrichissement avec les arrondissements des stations {.unnumbered} -->

```{r importData, results='hide'}
bixi_raw_data_df = read.csv("bixi1.csv", sep=",", header = T)
head(bixi_raw_data_df)
```

```{r importMergeStationNameAndCoord, results='hide'}
# Importation des données de stations: Nom, latitude et Longitude
stations_raw_data_df=read.csv("2021_stations.csv", sep = ",", header = T, encoding='latin_1')
head(stations_raw_data_df)

#Jointure aux données bixi
bixi_with_name_df=merge(bixi_raw_data_df,stations_raw_data_df, by.x = "station",by.y = "pk", all.x = T, all.y = F)
head(bixi_with_name_df)
str(bixi_with_name_df)
```

```{r , results='hide'}
# Validons qu'il n'y a pas de données manquantes suite à l'ajout des noms des stations et leur coordonnées géographique
summary(bixi_with_name_df)
```

```{r, results='hide'}
#Importation des données de stations: Nom, arrondissement, latitude, longitude
bixi_stations_df=read.csv("bixi_stations_full.csv", sep = ",", header = T, encoding='latin_1')
bixi_stations_df$STATIONARRONDISSEMENT[bixi_stations_df$STATIONARRONDISSEMENT=="Mont-Royal"]="Le Plateau-Mont-Royal"
# bixi_stations_df$STATIONARRONDISSEMENT[bixi_stations_df$STATIONARRONDISSEMENT=="Côte-des-Neiges - Notre-Dame-de-Grâce"]="Côte-des-Neiges-Notre-Dame-de-Grâce"
# bixi_stations_df$STATIONARRONDISSEMENT[bixi_stations_df$STATIONARRONDISSEMENT=="Mercier - Hochelaga-Maisonneuve"]="Mercier-Hochelaga-Maisonneuve"
# bixi_stations_df$STATIONARRONDISSEMENT[bixi_stations_df$STATIONARRONDISSEMENT=="Rosemont - La Petite-Patrie"]="Rosemont-La Petite-Patrie"
# bixi_stations_df$STATIONARRONDISSEMENT[bixi_stations_df$STATIONARRONDISSEMENT=="Rivière-des-Prairies - Pointe-aux-Trembles"]="Rivière-des-Prairies–Pointe-aux-Trembles"
# bixi_stations_df$STATIONARRONDISSEMENT[bixi_stations_df$STATIONARRONDISSEMENT=="Villeray - Saint-Michel - Parc-Extension"]="Villeray–Saint-Michel–Parc-Extension"
head(bixi_stations_df)

# merge pour inclure les arrondissements
bixi_with_arrond_df=merge(bixi_with_name_df,bixi_stations_df, by.x = 'name',by.y = 'STATIONNAME', all.x = T, all.y = F)
head(bixi_with_arrond_df)
```

```{r, include=FALSE}
#write.csv(bixi_stations_df,file="bixi_stations_full2.csv",sep = ",", row.names = F) 
```

```{r, results='hide'}
summary(bixi_with_arrond_df)
```
```{r, results='hide'}
bixiWithArron_clean_df=data.frame(name=bixi_with_arrond_df$name,latitude=bixi_with_arrond_df$latitude,
      longitude=bixi_with_arrond_df$longitude,arrondissement=bixi_with_arrond_df$STATIONARRONDISSEMENT,
      bixi_with_arrond_df[,names(bixi_raw_data_df)])
bixiWithArron_clean_df
```

# Transformation variables d'intérêts

Nous allons observer nos variables d'intérêts pour voir si elles se prêtent à l'analyse statistique.

```{r histn, out.height = "30%", fig.cap="Distribution des déplacements totaux", fig.align='center'}
par(mfrow=c(1,2))
hist(dat_mod$n_tot, 
     ylab = "Fréquence", 
     xlab = "Nombre de déplacement totaux",
     main = "")

dat_mod = dat_mod %>% mutate(n_tot_mod = log(n_tot))
hist(dat_mod$n_tot_mo, 
     ylab = "Fréquence", 
     xlab = "Nombre de déplacement totaux",
     main = "")
```

Dans la figure de gauche \@ref(fig:histn), on voit que les données de la variable `n_tot` ne sont pas normales, il faudrait les normaliser pour être capable de faire des analyses statistiques à l'aide de régression linéaire.

<!-- # ```{r histn2, out.height = "30%", fig.cap="Distribution du log des déplacements totaux", fig.align='center'} -->
<!-- # dat_mod = dat_mod %>% mutate(n_tot_mod = log(n_tot)) -->
<!-- # hist(dat_mod$n_tot_mo,  -->
<!-- #      ylab = "Fréquence",  -->
<!-- #      xlab = "Nombre de déplacement totaux", -->
<!-- #      main = "") -->
<!-- # ``` -->

Maintenant, dans la figure de droite \@ref(fig:histn), on voit qu'avec une transformation logarithmique, les données se normalisent. Par contre, le côté gauche de la courbe est encore relevé, cela peut impacter l'inférence statistique que nous allons faire prochainement.


# Impact des lieux touristiques
Dans cette section, nous voulons analyser l'impact du nombre des lieux touristiques sur l'utilisation des Bixi. Pour cela, nous utilisons le jeu de données sur les lieux d'intérêt disponible dans les données ouvertes de la ville de montréal à l'adresse url https://donnees.montreal.ca/dataset/lieux-d-interet. Nous calculons le nombre de sites touristiques (variable `n_tour`) par arrondissement que nous fusionnons à nos données `bixi`. 
<!-- Nous agrégeons ces données par arrondissement pour les fusionner à nos données bixi. À partir de ces données, nous créons deux variables:  
- `lieuxTouristiques` (1 ou 0): indique s'il y a un lieu touristique dans l'arrondissement (1) ou non (0)
- `n_touristiques`: nombre de lieux touristiques dans l'arrondissement. -->
Nous considérons comme lieux touristiques, les sites qui sont dans les catégories `Établissement culturel`, `Bâtiment et lieu d'intérêt`, `Art public`, `Circuit et parcours`, `Attrait touristique`, `Lieu de diffusion` et `Centre de congrès / d'exposition`. Les données pour les arrondissements de `longueuil` et `laval` sont tirés respectivement de https://www.donneesquebec.ca/recherche/dataset/installations et https://www.donneesquebec.ca/recherche/dataset/sites-de-loisirs
```{r, results='hide'}
#Import lieux intérêts montréal
mtl_lieuxInterets_raw_data_df=read.csv("lieux_d_interet.csv", sep = ",", header = T)
mtl_lieuxInterets_raw_data_df

#Import lieux intérêts longueuil
longueuil_lieuxInterets_raw_data_df=read.csv("installations_longueuil_riche.csv", sep=",", header = T, encoding = 'latin_1')
longueuil_lieuxInterets_raw_data_df

#Import lieux intérêts laval
laval_lieuxInterets_raw_data_df=read.csv("sites-de-loisirs_laval.csv", sep=",", header = T)
laval_lieuxInterets_raw_data_df
```
```{r, results='hide'}
#Montréal: Nombre de site par arrondissement
cat_lieux_touristique=c("Établissement culturel","Bâtiment et lieu d'intérêt","Art public","Circuit et parcours","Attrait touristique","Lieu de diffusion","Centre de congrès / d'exposition")
mtl_lieuxInterets_df=mtl_lieuxInterets_raw_data_df[mtl_lieuxInterets_raw_data_df$Catégorie %in% cat_lieux_touristique,]
nb_sitesTouristiques_by_arrondissement <- mtl_lieuxInterets_df %>% 
  group_by(Arrondissement) %>%
  summarise(nb_tour=n())

#On ajuste le nom des arrondissements pour s'aligner avec ceux dans nos données bixi
nb_sitesTouristiques_by_arrondissement$Arrondissement[nb_sitesTouristiques_by_arrondissement$Arrondissement=="Côte-des-Neiges–Notre-Dame-de-Grâce"]="Côte-des-Neiges - Notre-Dame-de-Grâce"
nb_sitesTouristiques_by_arrondissement$Arrondissement[nb_sitesTouristiques_by_arrondissement$Arrondissement=="Mercier–Hochelaga-Maisonneuve"]="Mercier - Hochelaga-Maisonneuve"
#nb_sitesTouristiques_by_arrondissement$Arrondissement[nb_sitesTouristiques_by_arrondissement$Arrondissement=="Le Plateau-Mont-Royal"]="Mont-Royal"
nb_sitesTouristiques_by_arrondissement$Arrondissement[nb_sitesTouristiques_by_arrondissement$Arrondissement=="Rivière-des-Prairies–Pointe-aux-Trembles"]="Rivière-des-Prairies - Pointe-aux-Trembles"
nb_sitesTouristiques_by_arrondissement$Arrondissement[nb_sitesTouristiques_by_arrondissement$Arrondissement=="Rosemont–La Petite-Patrie"]="Rosemont - La Petite-Patrie"
nb_sitesTouristiques_by_arrondissement$Arrondissement[nb_sitesTouristiques_by_arrondissement$Arrondissement=="Villeray–Saint-Michel–Parc-Extension"]="Villeray - Saint-Michel - Parc-Extension"
nb_sitesTouristiques_by_arrondissement$Arrondissement[nb_sitesTouristiques_by_arrondissement$Arrondissement=="Ville de Westmount"]="Westmount"

#Longueuil: Nombre de site par arrondissement
longueuil_lieuxInterets_df=longueuil_lieuxInterets_raw_data_df[longueuil_lieuxInterets_raw_data_df$ARRONDISSEMENT=="Arrondissement du Vieux-Longueuil" & longueuil_lieuxInterets_raw_data_df$Catégorie=="Tourisme",]
longueuil_nb_tour=nrow(longueuil_lieuxInterets_df)
nb_sitesTouristiques_by_arrondissement=rbind(nb_sitesTouristiques_by_arrondissement,
          data.frame(Arrondissement='Longueuil',nb_tour=longueuil_nb_tour))

#Laval: Nombre de site par arrondissement
cat_lieux_touristique_laval=c("Aréna","Salle de spectacle","Centre de création / Espace de diffusion","Centre sportif")
laval_lieuxInterets_df=laval_lieuxInterets_raw_data_df[laval_lieuxInterets_raw_data_df$descr_type_site %in% cat_lieux_touristique_laval,]
laval_nb_tour=nrow(laval_lieuxInterets_df)
nb_sitesTouristiques_by_arrondissement=rbind(nb_sitesTouristiques_by_arrondissement,
          data.frame(Arrondissement='Laval',nb_tour=laval_nb_tour))

nb_sitesTouristiques_by_arrondissement

#Merge avec les données bixi
bixi_df=merge(bixiWithArron_clean_df,nb_sitesTouristiques_by_arrondissement,by.x = 'arrondissement',by.y = 'Arrondissement', all.x = T, all.y = F)
bixi_df$wday <- as.factor(bixi_df$wday)
bixi_df$mem <- as.factor(bixi_df$mem)
bixi_df
```
```{r, results='hide'}
bixi_df[is.na(bixi_df$nb_tour),]
```

Étant donné que plusieurs satitions bixi se retrouvent dans un arrondissement, pour évaluer l'impact du nombre de sites touristiques par arrondissement sur l'utilisation des bixi, nous agrégeons nos données par arrondissement, par jour et par type de membre, en prenant la somme des variables `dur`, `rev`, `n_AM`, `n_PM`, `n_tot` et la moyenne des variables `temp` et `rain` pour toutes les stations dans un arrondissement. Nous introduisons ensuite les variables `nb_tour` et `n_stat` pour respectivement le nombre de sites touristiques et le nombre de station dans chaque arrondissement. Ainsi, nous analysons l'impact du nombre de sites touristiques dans chaque arrondissement, sur le nombre total de déplacement dans l'arrondissement. Ce dernier est la somme du nombre total de déplacements partant des stations qui sont dans l'arrondissement. Notre variable cible est le logarithme du nombre total de déplacement dans les arrondissements (`log(sum_n_tot)`).

```{r, results='hide', fig.keep='none'}
#Scatter plot pour voir à quoi ressemble la relation entre le nombre de sites touristique par arrondissement et log(n_tot) si on n'agrège pas les données par arrondissement
ggplot(bixi_df, aes(x=nb_tour, y=log(n_tot))) + geom_point() + geom_smooth(method='lm')
```
```{r, results='hide'}
# Agrégation des données par arrondissement en utilisant la moyenne (abandonné. J'utilise la somme)
var_agg=c("dur","rev","n_AM","n_PM","n_tot","temp","rain","nb_tour")
var_agg_rename=var_agg[var_agg != "nb_tour"]
bixi_agg_arrond_df <- bixi_df %>% 
  group_by(arrondissement, mm,dd,wday,mem,holiday) %>%
  summarise(across(var_agg, mean))
bixi_agg_arrond_df=as.data.frame(bixi_agg_arrond_df)
setnames(bixi_agg_arrond_df,old = var_agg_rename, new = paste0('avg_',var_agg_rename))
bixi_agg_arrond_df$arrondissement <- as.factor(bixi_agg_arrond_df$arrondissement)
bixi_agg_arrond_df

# Agrégation des données par arrondissement en utilisant la somme
var_agg_sum=c("dur","rev","n_AM","n_PM","n_tot")
var_agg_mean=c("temp","rain","nb_tour")
var_agg_rename_mean=var_agg_mean[var_agg_mean != "nb_tour"]
bixi_agg_arrond_df2 <- bixi_df %>% 
  group_by(arrondissement, mm,dd,wday,mem,holiday) %>%
  summarise(across(var_agg_sum,sum),across(var_agg, mean), n_stat=n_distinct(station))
bixi_agg_arrond_df2=as.data.frame(bixi_agg_arrond_df2)
setnames(bixi_agg_arrond_df2,old = var_agg_sum, new = paste0('sum_',var_agg_sum))
setnames(bixi_agg_arrond_df2,old = var_agg_rename_mean, new = paste0('avg_',var_agg_rename_mean))
bixi_agg_arrond_df$arrondissement2 <- as.factor(bixi_agg_arrond_df2$arrondissement)
bixi_agg_arrond_df2
```
```{r, results='hide'}
summary(bixi_agg_arrond_df2)
```
```{r, results='hide'}
mean_nb_tour_by_arr=mean(bixi_agg_arrond_df2$nb_tour)
arr_with_max_nb_tour=bixi_agg_arrond_df2[which.max(bixi_agg_arrond_df2$nb_tour),'arrondissement']
max_nb_tour=max(bixi_agg_arrond_df2$nb_tour)
mean_station_by_arr=mean(bixi_agg_arrond_df2$n_stat)
max_station_by_arr=max(bixi_agg_arrond_df2$n_stat)
arr_with_max_n_stat=bixi_agg_arrond_df2[which.max(bixi_agg_arrond_df2$n_stat),'arrondissement']
```

En moyenne, il y a `r round(mean_nb_tour_by_arr,0)` sites touristiques par arrondissement. L'arrondissement de `r arr_with_max_nb_tour` est celui qui en comporte le plus avec `r max_nb_tour` sites touristiques. Il y a en moyenne `r round(mean_station_by_arr,0)` station par arrondissement. L'arrondissement de `r arr_with_max_n_stat` est celui qui en comporte le plus avec `r max_station_by_arr` stations.

## Modèle de régression linéaire simple

```{r, results='hide'}
#ggplot(bixi_agg_arrond_df, aes(x=nb_tour, y=log(n_tot))) + geom_point() + geom_smooth(method='lm')
mod1 <- lm(log(avg_n_tot) ~ nb_tour, data=bixi_agg_arrond_df)
summary(mod1)
```
```{r}
#modèle utilisant l'agrégat sum
mod1_sum <- lm(log(sum_n_tot) ~ nb_tour, data=bixi_agg_arrond_df2)
summary(mod1_sum)
```

Lorsqu'on tient compte uniquement du nombre de sites touristique par arrondissement, on constate que pour chaque augmentation d'une unité de ce dernier, en moyenne, le nombre total de déplacement par arrondissement, par jour et par type de membre augmente de `r round((exp(mod1_sum$coefficients['nb_tour'])-1)*100,2)`%. Et cette augmentation est significative. Qu'en-est-il lorsqu'on tient compte des autres variables? Le modèle de régression linéaire multiple nous permettra d'y répondre.

## Modèle de régression linéaire multiple

Tout d'abord, il est important de décrire notre modèle complet. Il est composé de toutes les variables sauf `station`, `arrondissement`, `rev`, `dur`, `avg`, `n_PM`, `n_AM`. 
La variable `station` qui est l'identification unique des stations, est exclue car elle ne comporte aucune codification. Donc elle n'apporte aucune information. Puisque nous avons agrégé les données à l'arrondissement, la variable n'est plus du tout pertinente. 

La variable `arrondissement` est exclue car elle a une corrélation très forte avec `nb_tour` (nombre de sites touristiques dans la station) qui notre varible d'intérêt. L'ajustement d'un modèle qui inclus ces deux variables retourne `NA` pour l'un deux. Elle s'explique par le fait que quasiment tous les arrondissements ont des nombres de sites différents. Donc quasiment, chaque nombre de site correspond à un arrondissement différent. 

Les variables `rev` (revenu total généré) et `dur` (durée totale de tous les déplacements partant de la station au jour spécifié) sont exclues car ceux sont des variables cibles dans le cadre du projet et elles ont une corrélation presque parfaite avec la variable cible `n_tot` qui nous intéresse dans cette section. 

La variable `avg` (la durée moyenne (en minutes) de tous les déplacement partant d'une station au jour spécifié) est exclue car elle perd son sens suite à l'agrégat `somme` utilisée sur les variables pour agréger les données par arrondissement. Rappelons que pour agréger les données, nous calculons pour les variables la somme pour toutes les stations dans l'arrondissement. Soit $S$ l'ensemble des stations, indexé par $i$. Soit $A$ l'ensemble des arrondissements, indexé par $j$. Soit $N_j$: la somme du nombre total de déplacements par station dans l'arrondissement $j$.


\begin{equation} 
 N_j = \sum_{i=1}^{S} N_{i,j}=\sum_{i=1}^{S} D_{i,j}A_{i,j} \ne \sum_{i=1}^{S} D_{i,j}\sum_{i=1}^{S} A_{i,j} (\#eq:relationDurAvg)
\end{equation}

$N_{i,j},D_{i,j},A_{i,j}$ sont respectivement le nombre total de déplacement (variable `n_tot`), la durée totale des déplacements (variable `dur`) et la durée moyenne des déplacements (variable `avg`) pour la station $i$ dans l'arrondissement $j$. La relation décrite par l'équation \@ref(eq:relationDurAvg) décrit mathématiquement la raison pour laquelle nous excluons la variable `avg` dans les données agrégées. 

La variable `n_AM` et `n_PM` sont exclues car elles forment une combinaison linéaire avec `n_tot`. C'est à dire si le nombre total de déplacement change, forcément le nombre de déplacement en matinée et/ou en après-midi et/ou en soirée va changer. De plus les sites touristiques peuvent avoir un effet sur le nombre de déplacement en raison de leur heure d'ouverture. Il est donc absurde de controler le nombre de déplacement en journée ou en après-midi et même en soirée pour mesurer l'impact de la création d'un site sur le nombre total de déplacement.

À noter que dans le modèle, nous avons inclus le nombre de station dans l'arrondissement car il peut avoir un effet confondant. En effet, l'augmentation du nombre de stations peut rendre les sites touristiques ou d'autres sites non touristiques plus accessibles et générer plus de déplacement bixi et nous laisserait croire à tors que c'est l'augmentation des sites touristiques qui impacte les déplacements. 

```{r ModLieuTouristiqueAjustementModComplet, results='hide'}
mod2 <- lm(log(avg_n_tot) ~ mm + dd + wday+ mem + holiday + avg_n_AM + avg_temp + avg_rain + nb_tour , data=bixi_agg_arrond_df)
summary(mod2)
```

```{r ModLieuTouristiqueAjustementModCompletV2}
mod2_sum <- lm(log(sum_n_tot) ~ mm + dd + wday+ mem + holiday + avg_temp + avg_rain + nb_tour + n_stat, data=bixi_agg_arrond_df2)
summary(mod2_sum)
```

Même après avoir ajusté pour les autres variables, on constate que le nombre de site touristique a un effet significatif sur le nombre total de déplacement dans un arrondissement pour n'importe quel niveau de significance acceptable. En fait, pour chaque augmentation d'un site touristique dans un arrondissement, en moyenne, le nombre total de déplacement dans un arrondissement, par jour et par type de membre augmente d'environ `r round((exp(mod2_sum$coefficients['nb_tour'])-1)*100,2)`% lorsque les autres variables restent inchangées.  

De plus, l'impact des membres bixi sur le nombre total de trajet dans un arrondissement est `r round(exp(mod2_sum$coefficients['mem1']),0)` fois plus important que celui des non membres toujours lorsque les autres variables restent inchangés. Cet impact est aussi significatif pour n'importe quel niveau de significance acceptable. 

Une entente avec les villes pour construire d'avantage de lieux touristiques pourrait permettre d'accroitre l'utilisation des bixi. Puisque les membres semblent avoir un impact plus important sur l'utilisation des bixi que les non-membres, une stratégie visant à accroitre le portefeuille de client membre serait avantageux.

```{r, results='hide'}
#Analyse des résidus
mod2_resid <- rstudent(mod2)
mod2_fitted <-  mod2$fitted.values
mod2_log_avg_nTot <- log(bixi_agg_arrond_df$avg_n_tot)
mod2_resid_dat <- as.data.frame(cbind(mod2_log_avg_nTot,mod2_fitted,mod2_resid)) 
head(mod2_resid_dat)
```
```{r analyseResidusModeLieuxTouristiques,out.height = "30%", fig.align='center', fig.cap="Analyse des résidus studentisés du modèle de régression multiple avec les lieux touristiques", results='hide', fig.keep='none'}
plot1 <- ggplot(data = mod2_resid_dat, mapping = aes(x=mod2_resid)) + geom_density() + geom_histogram(aes(y=..density..), bins=10, alpha=0.5) + xlab("Résidus") + ggtitle("Distribution résidus")

plot2 <- ggplot(data = mod2_resid_dat, mapping = aes(sample=mod2_resid)) + stat_qq(distribution= qt, dparams = mod2$df.residual) + stat_qq_line(distribution = qt, dparams = mod2$df.residual) + labs(x="Quantiles théoriques", y="Quantiles empiriques") + ggtitle("QQ-Plot résidus")

plot3 <- ggplot(data = mod2_resid_dat, mapping = aes(x=mod2_log_avg_nTot, y=mod2_resid)) + geom_point() + geom_smooth() + theme(legend.position = "bottom") + labs(x="Valeurs ajustées", y="Résidus") + ggtitle("Nuage de points")

#grid.arrange(plot1, plot3, ncol = 2)
grid.arrange(plot1,plot2, plot3, ncol = 3)
```

```{r, results='hide'}
#Analyse des résidus pour modèle utilisant sum
mod2_sum_resid <- rstudent(mod2_sum)
mod2_sum_fitted <-  mod2_sum$fitted.values
mod2_sum_log_sum_nTot <- log(bixi_agg_arrond_df2$sum_n_tot)
mod2_sum_resid_dat <- as.data.frame(cbind(mod2_sum_log_sum_nTot,mod2_sum_fitted,mod2_sum_resid)) 
head(mod2_sum_resid_dat)
```
```{r analyseResidusModeLieuxTouristiques2,out.height = "30%", fig.align='center', fig.cap="Analyse des résidus studentisés du modèle de régression multiple avec les lieux touristiques"}
plot1 <- ggplot(data = mod2_sum_resid_dat, mapping = aes(x=mod2_sum_resid)) + geom_density() + geom_histogram(aes(y=..density..), bins=10, alpha=0.5) + xlab("Résidus") + ggtitle("Distribution résidus")

plot2 <- ggplot(data = mod2_sum_resid_dat, mapping = aes(sample=mod2_sum_resid)) + stat_qq(distribution= qt, dparams = mod2_sum$df.residual) + stat_qq_line(distribution = qt, dparams = mod2_sum$df.residual) + labs(x="Quantiles théoriques", y="Quantiles empiriques") + ggtitle("QQ-Plot résidus")

plot3 <- ggplot(data = mod2_sum_resid_dat, mapping = aes(x=mod2_sum_log_sum_nTot, y=mod2_sum_resid)) + geom_point()  + theme(legend.position = "bottom") + labs(x="Valeurs ajustées", y="Résidus") + ggtitle("Nuage de points")

#grid.arrange(plot1, plot3, ncol = 2)
grid.arrange(plot1,plot2, plot3, ncol = 3)
```
Les deux premiers graphes de la figure \@ref(fig:analyseResidusModeLieuxTouristiques2) nous montre que les résidus sont approximativement normale avec une moyenne proche de 0. Sur le dernier graphique on ne voit pas d'effet d'entonoir, la variance nous parait globalement constante, mais pas bien centré autour de 0 pour les premières valeurs.

```{r ModLieuTouristiqueAjustementModCompletV2Log, results='hide'}
mod2_sum_log <- lm(log(sum_n_tot) ~ I(log(mm)) + I(log(dd)) + wday+ mem + holiday + avg_temp + avg_rain + I(log(nb_tour)) + I(log(n_stat)), data=bixi_agg_arrond_df2)
summary(mod2_sum_log)
```


```{r, results='hide'}
#Analyse des résidus pour modèle utilisant sum et log dans les variables
mod2_sum_log_resid <- rstudent(mod2_sum_log)
mod2_sum_log_fitted <-  mod2_sum_log$fitted.values
mod2_sum_log_sum_nTot2 <- log(bixi_agg_arrond_df2$sum_n_tot)
mod2_sum_log_resid_dat <- as.data.frame(cbind(mod2_sum_log_sum_nTot2,mod2_sum_log_fitted,mod2_sum_log_resid)) 
head(mod2_sum_log_resid_dat)
```

```{r analyseResidusModeLieuxTouristiques2Log,out.height = "30%", fig.align='center', fig.cap="Analyse des résidus studentisés du modèle de régression multiple avec les lieux touristiques", fig.keep='none'}
plot1 <- ggplot(data = mod2_sum_log_resid_dat, mapping = aes(x=mod2_sum_log_resid)) + geom_density() + geom_histogram(aes(y=..density..), bins=10, alpha=0.5) + xlab("Résidus") + ggtitle("Distribution résidus")

plot2 <- ggplot(data = mod2_sum_log_resid_dat, mapping = aes(sample=mod2_sum_log_resid)) + stat_qq(distribution= qt, dparams = mod2_sum_log$df.residual) + stat_qq_line(distribution = qt, dparams = mod2_sum_log$df.residual) + labs(x="Quantiles théoriques", y="Quantiles empiriques") + ggtitle("QQ-Plot résidus")

plot3 <- ggplot(data = mod2_sum_log_resid_dat, mapping = aes(x=mod2_sum_log_sum_nTot2, y=mod2_sum_log_resid)) + geom_point() + geom_smooth() + theme(legend.position = "bottom") + labs(x="Valeurs ajustées", y="Résidus") + ggtitle("Nuage de points")

#grid.arrange(plot1, plot3, ncol = 2)
grid.arrange(plot1,plot2, plot3, ncol = 3)
```
## Modèle avec interaction
Il peut être intéressant ici d'analyser l'interaction entre le nombre de stations par arrondissement et le type de membre 
```{r ModLieuTouristiqueAjustementModInteraction}
mod3 <- lm(log(sum_n_tot) ~ mm + dd + wday + holiday + avg_temp + avg_rain + nb_tour*mem +  n_stat , data=bixi_agg_arrond_df2)
summary(mod3)
```
Nous constatons que l'interaction entre le fait d'être membre et le nombre de site touristique sur l'utilisation des bixi est significatif à un niveau de signifiance de 5%. En fait l'impact du nombre de site touristique sur le nombre total de déplacement est plus important pour les membres que les non-membres. Donc, bixi devrait chercher à avoir plus de client qui sont membre, d'avantage dans les arrondissements où il y a plus de sites touristiques. 

```{r, fig.keep='none'}
ggplot(bixi_agg_arrond_df2, aes(x=nb_tour, y=sum_n_tot, col=mem)) + geom_point() + geom_line(aes(y=10^(mod3$fitted.values)), size=1)
```

```{r, results='hide'}
#Analyse des résidus pour modèle avec interaction
mod3_resid <- rstudent(mod3)
mod3_fitted <-  mod3$fitted.values
mod3_log_sum_nTot <- log(bixi_agg_arrond_df2$sum_n_tot)
mod3_resid_dat <- as.data.frame(cbind(mod3_log_sum_nTot,mod3_fitted,mod3_resid)) 
head(mod3_resid_dat)
```
```{r analyseResidusModeLieuxTouristiquesAvecInteraction,out.height = "30%", fig.align='center', fig.cap="Analyse des résidus studentisés du modèle de régression multiple avec interaction", fig.keep='none'}
plot1 <- ggplot(data = mod3_resid_dat, mapping = aes(x=mod3_resid)) + geom_density() + geom_histogram(aes(y=..density..), bins=10, alpha=0.5) + xlab("Résidus") + ggtitle("Distribution résidus")

plot2 <- ggplot(data = mod3_resid_dat, mapping = aes(sample=mod3_resid)) + stat_qq(distribution= qt, dparams = mod3$df.residual) + stat_qq_line(distribution = qt, dparams = mod3$df.residual) + labs(x="Quantiles théoriques", y="Quantiles empiriques") + ggtitle("QQ-Plot résidus")

plot3 <- ggplot(data = mod3_resid_dat, mapping = aes(x=mod3_log_sum_nTot, y=mod3_resid)) + geom_point()  + theme(legend.position = "bottom") + labs(x="Valeurs ajustées", y="Résidus") + ggtitle("Nuage de points")

#grid.arrange(plot1, plot3, ncol = 2)
grid.arrange(plot1,plot2, plot3, ncol = 3)
```
Les graphiques pour l'analyse des résidus du modèle avec interaction sont très similaire à ceux présentés à la figure \@ref(fig:analyseResidusModeLieuxTouristiques2). Les conclusions sont donc les mêmes. 

## Limitations
L'agrégation par arrondissement sur lesquel repose l'analyse peut mettre en évidence certaines limitations dans nos interprétations. En effet, nous nous sommes basés sur le nombre de sites touristiques dans l'arrondissement, sans forcément tenir compte de leur proximité vis à vis des stations dans l'arrondissement. Il aurait été plus juste de ne tenir compte des site touristiques qui sont dans un certains rayon des stations. De plus la sélection des sites considérés touristiques dans chaque arrondissement est assez subjectifs. Nous n'avons pas fait une exploration détaillée des données exogènes utilisées pour nous assurer de l'hamonie de la définition de ce que nous considérons comme lieux touristiques entre les données de la ville de montréal, laval et longueuil. Chacun de ses jeux de données ont des catégorisations différentes, et nous n'avions pas un dictionnaire qui explique les caractéristiques de chaque catégories dans les jeux de données respectifs. Nous nous sommes basés sur notre interprétation des segments dans ces données, ce qui peut introduire des biais dans notre analyse.

# Impact des festivals

Dans cette section, nous allons analyser si les festivals tenus dans la ville de Montréal ont un impact sur l'utilisation des Bixi. Cette question est intéressante, car elle permet, selon les résultats obtenus, de s'allier avec la ville de Montréal et différente organisations et organismes en lien avec les festivals pour promouvoir un moyen de déplacement moins intensif sur les émission de polluants. Plusieur stratégies d'affaires peuvent être pris selon les résultats. Par exemple : offrir des promotions dans les stations proches des festivals, augmenter la disponibilité des Bixi lors des festivals ou encore promouvoir le service à l'approche des différents festivals.

Pour tester cette question, nous allons produire plusieurs modèles de régression linéaire et faire de l'inférence sur les résultats obtenus. Les données des festivals viennent d'une archive disponible sur ce site web : <https://web.archive.org/web/20210928074344/https://www.mtl.org/fr/experience/guide-des-festivals-dete-montreal> et elles ont été compilées manuellement.

## Modèle linéaire simple

```{r fest1, out.height = "30%"}
mod_fest_1 = lm(n_tot_mod ~ festival, data = dat_mod)
summary(mod_fest_1)
```

Avec un modèle linéaire simple, la tenue de festival semble avoir un effet positif et significatif sur le nombre total de déplacements. En effet, un festival de plus par jour augmente en moyenne le nombre total de déplacement de 3.4% par jour par arrondissement (toutes choses étant égales par ailleurs). De plus, cette augmentation est significatif à un niveau de 95%.

Or, il est important de discuter des limitations d'un tel modèle. Plusieurs autres variables agissent sur le nombre total de déplacements et sur la tenue de festival, il faut ainsi controler pour ces variables. Pour mieux comprendre ce problème, voici un graphe orienté acyclique (GOA) \@ref(fig:firstgroup).

```{=tex}
\begin{figure}[h!]
\caption{\label{fig:firstgroup}}
\centering
\begin{tikzpicture}[->]
\node (X) at (0,0) {$festival$};
\node (Z2) at (1.5,-1) {$Z_1$};
\node (Y) at (3,0) {$n\_tot$};
\path (X) edge (Y);
\path (Z2) edge (X);
\path (Z2) edge (Y);
\end{tikzpicture}
\end{figure}
```
Ainsi, s'il existe des variables $Z_1$ qui affectent à la fois `festival` et `n_tot`, il faut ajouter ces variables dans le modèle pour avoir une estimation plus précises des effets des prédicteurs.

Au niveau de la normalité des résidus, on doit les analyser après la transformation logarithmique.


```{r festRes1, out.height = "30%", fig.align='center', fig.cap="Variance des résidus"}
resid <- rstudent(mod_fest_1)
fitted <- mod_fest_1$fitted.values
res.dat <- cbind(dat_mod, fitted, resid)

plot1 <- ggplot(data = res.dat, mapping = aes(x = resid)) + geom_density() +
geom_histogram(aes(y = ..density..), bins = 10, alpha = 0.5) +
xlab("Résidus") +
ylab("Densité")+
  ggtitle("Distribution des résidus")

plot2 <- ggplot(data = res.dat, aes(x = as.factor(festival), y = resid)) + geom_boxplot() + ylab("Résidus") +
xlab("Festival")

grid.arrange(plot1, plot2, ncol = 2)
```

En observant le figure à gauche \@ref(fig:festRes1) et celle a droite \@ref(fig:festRes1), on voit que les résidus semblent ne pas être normales dans le premier tiers des données. Par la suite, les résidus semblent se rapprocher d'un distribution normale. Or, étant donné que les résidus ne sont pas parfaitement normales, cela va poser des limitations dans l'analyse et l'inférence des résultats. Il ne semble pas avoir d'hétéroscédasticité dans les résidus.

## Modèle linéaire ajusté

Comme expliqué précédemment, nous devons ajouter des variables dans le modèles pour avoir une estimation plus précise. Il serait utile d'ajouter la variable `holiday`, `mm` et `wkend`. En effet, ces variables agissent à la fois sur `festival` et `n_tot`.

```{r, out.height = "30%"}
mod_fest_2 = lm(n_tot_mod ~ festival + mm + holiday + wkend, data = dat_mod)
summary(mod_fest_2)
```

En contrôlant pour les variables omises, nous observons maintenant un changement dans l'interprétation des résultats. L'effet des festival semble être négatif et non-significatif. Dans ce modèle, chaque festival diminue le nombre total de déplacement de 2,4% par jour par quartier de façon non-significative. Il semblerait que l'effet passe maintenant par les mois et non par les festivals.

Si nous analysons rapidement les résidus, nous voyons dans le figure à droite et à gauche \@ref(fig:fest-res2) qu'ils semblent légèrement plus normales que dans le premier modèle. Les résidus semblent encore homoscédastiques.

```{r fest-res2, out.height = "30%", fig.align='center', fig.cap="Distribution des résidus"}
resid <- rstudent(mod_fest_2)
fitted <- mod_fest_2$fitted.values
res.dat <- cbind(dat_mod, fitted, resid)

plot1 <- ggplot(data = res.dat, mapping = aes(x = resid)) + geom_density() +
geom_histogram(aes(y = ..density..), bins = 10, alpha = 0.5) +
xlab("Résidus") +
ylab("Densité")+
  ggtitle("Distribution des résidus")

plot2 <- ggplot(data = res.dat, aes(x = as.factor(festival), y = resid)) + geom_boxplot() + ylab("Résidus") +
xlab("Festival")

grid.arrange(plot1, plot2, ncol = 2)
  
```

### Modèle avec interaction

Il peut être intéressant de tester un modèle avec interactions étant donné que les utilisations seront peut-être augmenté si un festival est pendant une fin de semaine ou une journée férié.

```{r}
mod_fest_3 = lm(n_tot_mod ~ festival*holiday +festival*wkend +festival + mm + holiday + wkend, data = dat_mod)
summary(mod_fest_3)
```

Or, il ne semble pas avoir d'effets non plus.

### Modèle avec seulement les non-membres

Il serait aussi intéressant de tester si les non-membres (qui ont une utilisation différente des Bixi) utilisent plus les Bixi lors des festivals. Pour cela, nous allons tester le deuxième modèle sur les non-membres seulement.

```{r, out.height = "30%"}
mod_fest_4 = lm(n_tot_mod ~ festival + mm + holiday + wkend, data = dat_mod[dat_mod$mem == 0,])
summary(mod_fest_4)
```

De façon similaire au modèle précédemment, les festivals n'ont pas d'effets significatifs même lorsqu'on regarde seulement les non-membres de Bixi.

## Discussion sur les résultats

Étant donné les résultats des modèles que nous avons fait précédemment, les festivals ne semblent pas avoir d'effets significatifs sur l'utilisation des Bixi que cela soit pour les membres ou les non-membres. Ainsi, nous ne pouvons pas nous prononcer sur des politiques et stratégies que l'entreprise pourrait appliquer.

# Impact de la densité de population

Dans cette section, il sera question de modéliser l'effet de la densité de la population par $km^2$ par arrondissement, sur le nombre total de déplacements en Bixi par arrondissement. Autrement dit, on essaye d'observer qu'est-ce qui arrive au nombre de totaux de déplacement si la densité de population augmente. À première vue, il est cohérent d'affirmer que si la densité de la population augmente, le nombre de déplacement à bicyclette augmentera aussi. Cette prémisse repose sur l'idée qu'une densité de population plus élevée favorise généralement la mise en place d'infrastructures favorables aux déplacements à bicyclette.

Pour Bixi ce type d'information devient alors crucial, d'une part puisque dans les zones à forte densité de population, les habitants ont souvent plus d'options de transport, ce qui peut réduire leur dépendance à la voiture favorisant ainsi l'utilisation des transports durable comme le vélo. D'autre part, les zones fortement densifiées ont généralement une plus grande concentration de commerce, de services publics et d'emploi à moindre distance. Cette proximité des destinations encourage alors l'utilisation de modes de transport adaptés aux déplacements courts, tels que le vélo. C'est pour ces raisons que nous pensons que la densité de la population est un excellent facteur à observer pour Bixi.

Enfin, les données ajoutées on été receuillis sur les site web de statistiques canada, données montréal et l'institus de la statistiques du quebec. Cette section sera principalement divisé en trois partie. Tout d'abord, il sera question d'un modèle de régression simple, ensuite d'un mudèle multivariée et pour conclure avec une disscussion sur les limitation des modèles présenté.

```{r initialisation des données, results='hide'}
library(stringr)
dat_pop <- read.csv("pop_arrondissement.csv")

dat_pop$Superficie <- gsub(",", ".", dat_pop$Superficie)
dat_pop$Superficie <- as.numeric(dat_pop$Superficie)

dat_pop$Population.2021. <- str_replace_all(dat_pop$Population.2021., "\\s", "")
dat_pop$Population.2021. <- as.numeric(dat_pop$Population.2021.)


dat_pop <- dat_pop %>% 
  rename(
    arrond = Nom,
    superficie = Superficie,
    population_2021 = Population.2021.
  )
dat_pop$density <- dat_pop$population_2021/dat_pop$superficie

dat_mod$arrond <- str_replace_all(dat_mod$arrond, " - ", "-")
dat_pop$arrond <- str_replace_all(dat_pop$arrond, "–", "-")

df_lieux_mtl <- read.csv("lieux-fr_MTL.csv")
df_lieux_mtl_1 <- read.csv("lieux-fr_MTL.csv")
df_lieux_long <- read.csv("vdq-lieupublic_longeuil.csv")
df_lieux_la <- read.csv("lieux_laval.csv")


df_lieux_la$type.commun <- as.factor(df_lieux_la$type.commun)
df_lieux_mtl$installations <- as.factor(df_lieux_mtl$installations)
df_lieux_long$DESCRIPTION <- as.factor(df_lieux_long$DESCRIPTION)

unique(df_lieux_long$DESCRIPTION)
unique(df_lieux_mtl$installations)
unique(df_lieux_la$type.commun)

intersect(df_lieux_la$type.commun, df_lieux_mtl$installations)

df_lieux_la$type.commun <- str_replace(df_lieux_la$type.commun, "Parcs linéaires|Parcs écoles", "Parc")

df_lieux_la <- subset(df_lieux_la, type.commun %in% c("Parc",
                                                      "Bibliothèque",
                                                      "Centre communautaire",
                                                      "Centre sportif"))

category_counts <- table(df_lieux_la$type.commun)

# Creation du DF pour Laval 
df_lieux_la <- data.frame(
  Category = c("Parc",
  "Bibliotheque",
  "Centre_communautaire",
  "Centre_sportif"),
  Count = c(category_counts["Parc"],
            category_counts["Bibliothèque"],
            category_counts["Centre communautaire"],
            category_counts["Centre sportif"])
)
df_lieux_la <- pivot_wider(df_lieux_la, names_from = Category, values_from = Count)
df_lieux_la$arrond <- "Laval"

# Création du DF pour mtl. 
df_lieux_mtl <- df_lieux_mtl %>%
  filter(installations %in% c("Parc","Bibliothèque","Centre communautaire","Centre sportif")) %>%
  group_by(arrondissements) %>%
  summarize(
    Parc = sum(installations == "Parc"),
    Bibliotheque = sum(installations == "Bibliothèque"),
    Centre_communautaire=sum(installations == "Centre communautaire"),
    Centre_sportif=sum(installations == "Centre sportif")
  )

df_lieux_mtl$arrond <- df_lieux_mtl$arrondissements
df_lieux_mtl <- df_lieux_mtl[2:6]

# Création du DF pour longeuil 
df_lieux_long$DESCRIPTION <- str_replace(df_lieux_long$DESCRIPTION, "Parcs écoles", "Parc")
category_counts <- table(df_lieux_long$DESCRIPTION)

df_lieux_long <- data.frame(
  Category = c("Parc",
  "Bibliotheque",
  "Centre_communautaire",
  "Centre_sportif"),
  Count = c(category_counts["Parc"],
            category_counts["Bibliothèques"],
            category_counts["Centres communautaires"],
            category_counts["Centres sportifs"])
)

df_lieux_long <- pivot_wider(df_lieux_long, names_from = Category, values_from = Count)
df_lieux_long$arrond <- "Longueuil"

df_la_long <- rbind(df_lieux_long,df_lieux_la)

# Ces données ne sont pas disponible sous forme CSV, mais sont dispoible sur le site web des villes 
df_Westmont_MR <- data.frame(
  Parc=c(12,22),
  Bibliotheque=c(1,1),
  Centre_communautaire=c(20,19),
  Centre_sportif=c(1,2),
  arrond=c("Westmount","Mont-Royal")
)

df_la_long<- rbind(df_la_long,df_Westmont_MR)

df_rmr <- rbind(df_la_long,df_lieux_mtl)

df_rmr$arrond <- str_replace_all(df_rmr$arrond, " - ", "-")
df_rmr$arrond <- str_replace_all(df_rmr$arrond, "–", "-") 


setdiff(dat_mod$arrond, df_rmr$arrond)

df_rmr<- dat_pop %>% left_join(df_rmr, by="arrond")

# Division des parc, biblio et les centres par la superficie. Permet de standardisé selon la grandeur du territoire
df_rmr <- df_rmr %>%
  mutate(
    ParcKm2 = Parc / superficie,
    BibliothequeKm2 = Bibliotheque / superficie,
    Centre_communautaireKm2 = Centre_communautaire / superficie,
    Centre_sportifKm2 = Centre_sportif / superficie
  )


dat_mod<- dat_mod %>% left_join(df_rmr, by="arrond")

```

## Modèle linéaire simple

Dans ce modèle de régression linéaire simple, il est possible de constater que la variable de densité est bien significative. Autrement dit, une augmentation d'une personne par kilomètre carré augmenterait en moyenne le nombre total de déplacements de 0.012. Cependant, la valeur du $R^2$ signifie que le modèle explique 19,17% de la variabilité du nombre total de déplacements. Cela dit, il y a nécessairement un manque de variables explicatives qui permettrait de mieux expliquer la variable réponse.

Avant d'amorcer un modèle multiple, il est crutial d'observer si l'hypothèse d'homoscédasticité est respectées dans ce modèle simple.

```{r SimpleDensity}

#options(scipen=999)

model_density <- lm(n_tot~density ,dat_mod )

summary(model_density)

```

Dans ce même ordre d'idée, il est possible d'observer si l'hypothèse de normalité des résidus ainsi que l'hypothèse d'homoscédasticité sont respectées dans ce modèle simple, avant d'amorcer un modèle multiple. En examinant le comportement des résidus dans la figure \@ref(fig:QQdensite), il est plausible de dire que dans le dernier tiers de la figure les résidus ne suivent pas une loi normale. Cela étant dit, dans le cas de ce modèle simple, ça voudrait dire que la densité comme seule variable explicative explique mal le comportement du nombre total de déplacements en Bixi. Il est possible dans ce cas de faire une transformation logarithmique pour rendre les données extrêmes plus symétriques. Cependant, puiqu'on sait que le modèle linéaire simple n'est pas approprié, on préfère passer au modèle multiple et appliquer, dans le besoin, ces changements dans un modèle plus approprié.

```{r QQdensite, out.height = "30%", fig.align = 'center', fig.cap = "Graphique QQ - modèle de densité démographique simple"}

library(lmtest)
residuals <- residuals(model_density)


ggplot(data.frame(Résidus = residuals), aes(sample = Résidus)) +
  stat_qq() +
  stat_qq_line() +
  xlab("Quantiles Théoriques") +
  ylab("Quantiles de l'Échantillon") +
  ggtitle("Graphique Q-Q")

```

## Modèle ajusté

Avant de débuter le modèle multiple avec la densité de population, il est important de comprendre que plusieurs données ont été ajoutées et même modifier pour pouvoir observer la tendance que prend l'utilisation des Bixis lorsque la densité de population augmente. Cela étant dit, il était important d'ajouter des variables qui affectaient autant la densité de population que le nombre total de déplacement en Bixi, si l'on veut capter l'effet de la densité, comme expliqué dans la figure \@ref(fig:firstgroup). Par conséquent, des variables comme le nombre de parcs `Parc` par arrondissement, le nombre de bibliothèques par arrondissement `Bibliotheque`, le nombre de centres communautaire par arrondissement `Centre_communautaire` et le nombre de centres sportifs par arrondissement `Centre_sportif` ont été ajoutés. De plus, puisque la superficie des arrondissements varie grandement, ces variables ajoutées ont été divisées par la superficie de chaque arrondissement. Ainsi les grandes villes, comme Laval qui a beaucoup d'infrastructure à cause de sa grande superficie, ne viendront pas biaiser nos modèles. Autrement dit, les variables ajoutées(nombre de parcs, le nombre de bibliothèques, le nombre de centres communautaires, le nombre de centres sportifs) sont par $km^2$ de leur arrondissement.

Dans la régression multiple ci-dessous, il est possible de constater que le coefficient de `logBibliothequeKm2` est négatif affecte négativement le nombre de déplacement. Cependant, ce n'est pas nécessairement vrai, puisqu'en observant les données on peut remarquer que la ville de Longueuil a excessivement beaucoup de bibliothèques contrairement aux autres arrondissements, ce qui vient biaiser nos données, puisqu’en plus c’est une ville ou le déplacement en voiture est plus courant. Aussi, `logCentre_sportifKm2` n'est pas significatif dans le modèle. C'est-à-dire que la probabilité de faire une erreur en rejetant l'hypothèse nulle où le coefficient de `logCentre_sportifKm2` est nul est élevée.

De plus, en supposant que l'indépendance entre le nombre de déplacements `n_tot` et le terme d'erreur, une variation de 1% de la densité de la population serait associée, dans ce modèle, à une variation moyenne de 1.66% du nombre de déplacements total en bixi. Cependant, l'hypothèse d'indépendance n'est pas nécessairement respectée dans ce cas. Pour cette raison, cette interprétation n'est pas totalement véridique et ne sera pas utilisée dans les modèles à venir, puisqu'on sait qu'il y a des variables qui ne sont pas prises en compte, comme le nombre de pistes cyclables, etc. Cela étant dit, on peut tout de même affirmer que l'effet de la densité sur le nombre total de déplacements est positif.


```{r}
dat_mod$logDensity <- log(dat_mod$density)
dat_mod$logParcKm2 <- log(dat_mod$ParcKm2)
dat_mod$logBibliothequeKm2 <- log(dat_mod$BibliothequeKm2)
dat_mod$logCentre_communautaireKm2 <- log(dat_mod$Centre_communautaireKm2 + 0.01)
dat_mod$logCentre_sportifKm2 <- log(dat_mod$Centre_sportifKm2 + 0.01)

modele_densite <- lm(n_tot_mod ~ logDensity + logParcKm2 + logBibliothequeKm2 + logCentre_communautaireKm2 + logCentre_sportifKm2, data = dat_mod)

summary(modele_densite)
```

Dans la figure à gauche ci-dessous \@ref(fig:residualsDensityMult) on peut remarquer que la variance entre des valeurs prédites n'est pas constante. Cela étant dit, l'hypothèse d'homoscédasticité est violée.Aussi, la figure à droite \@ref(fig:residualsDensityMult) quant a elle mesure la normalité des données. Puisque la transformation logarithmique des données a permis de contourner l'asymétrie des données, il est possible d'apercevoir que même si les queues du graphique QQ s'éloignent de la ligne, qu'il y a une certaine normalité dans les données.


```{r residualsDensityMult, out.height = "30%", fig.align = 'center', fig.cap = "Graphique des résidus"}

residuals_data <- data.frame(Fitted_Values = modele_densite$fitted.values, Residuals = resid(modele_densite))


plot1 <- ggplot(residuals_data, aes(x = Fitted_Values, y = Residuals)) +
  geom_point() +
  xlab("Valeurs prédites") +
  ylab("Résidus") +
  ggtitle("Graphique des résidus par rapport\naux valeurs prédites") +
  geom_hline(yintercept = 0, color = "red", linetype = "dashed")

residuals <- residuals(modele_densite)
plot2 <- ggplot(data.frame(Résidus = residuals), aes(sample = Résidus)) +
  stat_qq() +
  stat_qq_line() +
  xlab("Quantiles Théoriques") +
  ylab("Quantiles de l'Échantillon") +
  ggtitle("Graphique Q-Q")

grid.arrange(plot1, plot2, ncol = 2)

```
## Modèle avec interactions

Compte-tenu que le nombre de parc, de bibliothèques, de centres communautaires et de centres sportifs peuvent être influencés par la densité de population dans une ville, il peut être interessant de générer un modèle qui inclut des interactions avec la densité et le nombre de ces différentes installations.

Encore une fois, nous allons utiliser le log de nos paramètres compte-tenu que leur distribution est asymétrique et ne suit pas une loi normale.

```{r}

modele2_interactions <- lm(n_tot_mod ~ logDensity + logParcKm2 + logBibliothequeKm2 + logCentre_communautaireKm2 + logCentre_sportifKm2 + logDensity*logParcKm2 + logDensity*logBibliothequeKm2 + logDensity*logCentre_communautaireKm2 + logDensity*logCentre_sportifKm2, data = dat_mod)

summary(modele2_interactions)
```

En examinant ce modèle, on constate que tous les paramètres sont significatifs à au moins 99,9% de confiance sauf pour les paramètres `logParcKm2` et `logDensity:logParcKm2` qui semblent ne pas être statistiquement significatifs. On peut aussi constater que si `logBibliothequeKm2` augmente de 1, alors le log du nombre de déplacement total augmentera de 13.44, puisque que ces variables sont sur l'échelle logarithmique, l'analyse des valeurs numérique perd un peu de son sens, cependant on peut comprendre qu'il y a un effet positif à l'augmentation du nombre de bibliothèque. Puisque les variables sont sur une échelle logarithmique, il faut aussi comprendre que les variables avec des coefficients négatifs ont ainsi très peu d'impact sur le nombre de déplacement total si elles augmentent de un. On remarque aussi que le R2 augmente en comparaison aux autres modèles incluant la densité pour une valeur de 37.34% ce qui veut dire que ce modèle explique un peu plus la variabilité du nombre total de déplacements que les autres ci-dessus avec la densité.

Suite aux observations de ce modèle, on peut dire que le nombre de bibliothèques, de centre communautaires et de centres sportifs influencent positivement le nombre de déplacement en Bixi et le nombre de parc n'a pas d'effet significatif.

Pour s'assurer de l'homoscédasticité et linéarité du modèle, on peut ensuite examiner les résidus avec les figure à droite \@ref(fig:distResDensiteMultipleInt) et celle a gauche \@ref(fig:distResDensiteMultipleInt).

```{r distResDensiteMultipleInt, out.height = "30%", fig.align = 'center', fig.cap = "Histograme des résidus - Graphique Q-Q "}

residuals <- residuals(modele2_interactions)


residuals_data <- data.frame(Fitted_Values = modele2_interactions$fitted.values, Residuals = resid(modele2_interactions))


plot1 <- ggplot(residuals_data, aes(x = Fitted_Values, y = Residuals)) +
  geom_point() + geom_smooth() +
  xlab("Valeurs prédites") +
  ylab("Résidus") +
  ggtitle("Graphique des résidus par rapport\naux valeurs prédites") +
  geom_hline(yintercept = 0, color = "red", linetype = "dashed")

plot3 <- ggplot(data.frame(Résidus = residuals), aes(x = rstudent(modele2_interactions))) + geom_density() + geom_histogram(aes(y = ..density..),
bins = 20, alpha = 0.5)+
xlab("Résidus") +
ylab("Densité")+
  ggtitle("Histogramme des résidus")

plot2 <- ggplot(data.frame(Résidus = residuals), aes(sample = Résidus)) +
  stat_qq() +
  stat_qq_line() +
  xlab("Quantiles Théoriques") +
  ylab("Quantiles de l'Échantillon") +
  ggtitle("Graphique Q-Q")
grid.arrange(plot1, plot2, ncol = 2)

```
On remarque dans la figure de gauche que la variance ne semble pas constante, ainsi nous ne pourrions pas dire que l'hypothèse d'homoscésasticité est respectée. D'après le QQ-plot à droite, on constate une allure normale des résidus, les quantiles semblent suivre raisonnablement la droite sur le graphique QQ.

### Modèle pour les non-membres

Ensuite, il peut être intéressant de construire un modèle avec les données des non-membres seulement pour voir si l'utilisation des bixis pour les non-membre est reliée de manière différente aux différentes infrastructures dans un arrondissement. Pour voir si l'entreprise Bixi devrait porter une attention différentes pour les non-membres ou pas.

```{r}
modele2_interactions_nm = lm(n_tot_mod ~ logDensity + logParcKm2 + logBibliothequeKm2 + logCentre_communautaireKm2 + logCentre_sportifKm2 + logDensity*logParcKm2 + logDensity*logBibliothequeKm2 + logDensity*logCentre_communautaireKm2 + logDensity*logCentre_sportifKm2, data = dat_mod[dat_mod$mem == 0,])
summary(modele2_interactions_nm)
```

On obtient des résultats similaires au modèle avec les données des membres aussi. Encore une fois, `logBibliothequeKm2` et `logDensity:logParcKm2` ne semblent pas très significatifs (`logBibliothequeKm2` l'est un peu plus). Cependant, on peut remarquer que le R2 à augmenté à 42.45%, ainsi le modèle avec les non-membres seulement explique un peu mieux la variance du log des déplacements totaux.

Nous approfondirons davantage ce sujet dans la conclusion, cependant, il est essentiel de noter que la société doit tenir compte des futurs projets de développement des villes afin d'accroître l'utilisation des Bixi.


## Limitations
Les limites des modèles ont été abordées tout au long de cette section, mais il est important de les rappeler. Puisque l'analyse des résidus a démontré que l'hypothèses d'homoscédasticité n'est pas respectée, les paramètres des modèles sont questionnables et biaisés, ainsi la fiabilité du modèle l'est aussi. Ces modèles ne sont d'aucun cas des modèles causaux, ils ont seulement réussi à capter les tendances que peuvent prendre les variables explicatives face au nombre total de déplacements. De plus, comme expliqué précédemment, il reste des variables qui affectent autant la variable cible que les variables explicatives dans le terme d'erreur. Par exemple, le nombre de kilométrages de piste cyclable est dans le terme d'erreur, mais affecte également le `n_tot` et `density`. Cela dit, il manque plusieurs variables de contrôles à nos modèles, mais nous pensons avoir bien capté la tendance que les variables explicatives peuvent prendre.


# Conclusion
Pour conclure, toutes ces informations sont importantes pour l'OBNL. Elles expliquent en bref, qu'en moyenne, les arrondissements plus densifiés et l'ajout de certaines infrastructures dans les villes augmentent le nombre d'utilisations des bixi, ce qui est cohérent avec notre hypothèse.En contrepartie, il est à noter que les festivals n'ont aucun impact sur le nombre total de déplacements dans nos modèles. Néanmoins, il pourrait être pertinent d'approfondir l'analyse pour évaluer leur influence et, le cas échéant, d'adapter les politiques de Bixi en conséquence. À cet effet, il est possible de se demander si ça ne serait pas intéressant pour la compagnie de se coordonner avec les planificateurs urbains des villes pour arrimer l'ajout de station de bixi aux futurs projets de développement urbain des arrondissements. Cela étant dit, ça permettrait d'augmenter le nombre de déplacements en bixi et de diminuer le nombre de véhicules non écologiques sur les routes.

