---
title: "Projet BIXI - Partie 1: Analyse exploratoire"
subtitle: "MATH60604 - Modélisation statistique"
author: "James Roy,Alfred Assal,Samuel Croteau,Abdoul Wassi Badirou"
date: "`r Sys.Date()`"
output: 
  #bookdown::pdf_document2:
  bookdown::html_document2:
    toc: true 
    number_sections: true
    toc_float: # to float the table of contents to the left of the main document content.
      collapsed: false
  pdf_document:
  html_document:
    toc: true 
    number_sections: true
    toc_float: # to float the table of contents to the left of the main document content.
      collapsed: false
params:
  created_date: '2023-09-12'
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
knitr::opts_chunk$set(message = FALSE)
knitr::opts_chunk$set(warning = FALSE)
knitr::opts_chunk$set(error = FALSE)
```

```{r}
library(tidyverse)
library(ggthemes)
library(RColorBrewer)
library(knitr)
```

# Notes

## Analyse exploratoire

Les variables cibles sont:

-   Utilisation: `n_Tot`

-   Durée: `dur`

-   Revenu: `rev`

### Analyse univariée

-   Encoder les variables qualitatives avec le as.factor

-   Histogramme de nombre de station par rapport à la fréquence (nom)

    -   s'interroger sur les cas extrêmes

    -   voir si la distribution est normal ou skewed

    -   vérifier s'il y a des valeurs manquantes et essayer de les justifier

-   Pourcentage des membres et non membres

-   Pour les variables qualitatives

    -   vérifier s'il y a des valeurs manquantes et essayer de les justifier

    -   boxplot et distribution

        -   Voir les valeurs abérantes et/ou extrêmes

### Analyse multivariée

-   Samuel: n_Tot

-   Alfred: rev

-   James: dur

-   Identifier le meilleur moment qui maximise l'utilisation des bixi.

-   Avec les données géographiques, identifier le meilleur endroit où il y a le plus d'apétence pour les bixi.

-   Voir s'il y a une relation à faire entre les stations les plus fréquentées et l'arrondissement

-   Comparaison entre variables explicatives et variables objectives

    -   moy n_tot vs température, pluie , jour de la semaine, weekend, AM, PM

    -   jours de la semaine Vs weekend

    -   Fériés Vs Non fériée

    -   Nombre de

-   Comparaison entres variables explicatives (covariables)

-   Vérifier par exemple si n_tot=n_AM + n_PM

    -   Rajouter la variable n_Nuit=n_tot-n_AM-n_PM

-   relation entre nombre total de déplacement et le revenu. Ca dépend de la proportion des membres. Car c'est possible qu'on ai des membres qui font beaucoup de déplacement mais pour lesquels on n'a pas de revenu.

-   Est-ce que les membres utilisent plus le bixi que les non-membres

-   Qui rapporte le plus entre les membres et non-membres

-   On peut calculer la corrélation entre les variables.

```{r}
dat = read.csv("bixi1.csv")

```

# Introduction

1.  Contexte
2.  Objectif
3.  Plan

# Exploration des données

Le jeu de données utilisé est fourni dans le fichier `bixi1.csv`. La première ligne du fichier est constituée des noms des différentes variables. La virgule est le séparateur du fichier `csv` et la décimale est représentée par un point.

Les tables \@ref(tab:6PremieresObservations) et \@ref(tab:6DernieresObservations) nous montrent à titre informatif, respectivement les 6 premières et 6 dernières observations du jeu de données. Nous retrouvons les variables telles que décrites dans le document xxx.

```{r imp-data}
#Importation des données
bixi_raw_data_df= dat
#bixi_raw_data_df=read.table("raw_data/bixi1.csv", sep = ",", header = T)
```

```{r 6PremieresObservations}
knitr::kable(head(bixi_raw_data_df), caption="6 premières observations du jeu de données")
```

```{r 6DernieresObservations}
knitr::kable(tail(bixi_raw_data_df), caption="6 dernières observations du jeu de données")
```

La visualisation de la structure compacte des données exposée ci-dessous, nous montre que le jeu de données est constitué de 10000 observations et 14 variables. Toutes les variables sont encodées numériquement à l'exception de la variable `wday` qui indique le jour de la semaine. Les six premières variables (de `station` à `holiday`) sont à priori des variables qualitatives. Nous les encoderons donc comme tels. Par ailleurs, certaines sont ordinalles, comme le mois (variable `mm`), le jour du mois (variable `dd`) et le jour de la semaine (variable `wday`). Nous y reviendrons plus en détails dans l'analyse exploratoire associée à chacune d'elles.

```{r dataStr, fig.cap="Structure du jeu de données"}
str(bixi_raw_data_df)
```

Après avoir encodé les 6 premières variables sous-forme qualitatives, le tableau présente une description sommaire des différentes variables. Regardons à présent de facon détaillée chacune d'elle.

```{r}
options(knitr.kable.NA = "")
bixi_df=data.frame(station=as.factor(bixi_raw_data_df$station),
                   mm=as.factor(bixi_raw_data_df$mm),
                   dd=as.factor(bixi_raw_data_df$dd),
                   wday=as.factor(bixi_raw_data_df$wday),
                   mem=as.factor(bixi_raw_data_df$mem),
                   holiday=as.factor(bixi_raw_data_df$holiday),
                   bixi_raw_data_df[,7:ncol(bixi_raw_data_df)])
knitr::kable(summary(bixi_df), caption="Sommaire des observations")
```

## Exploration univariée

### Les variables qualitatives

#### Station

La variable station est une variable qualitative qui représente les différentes stations de départ des trajets en BIXI. Nous l'avons encodé sous forme de variable qualitative nominale car il n'y a pas de relation d'ordre entre les différentes stations. La figure \@ref(fig:histNbObservationStation) montre le nombre de stations en fonction du nombres de leur observations dans les données.

```{r histNbObservationStation, fig.cap="Histogramme du nombre d'observations des stations"}
freqTable_station=table(bixi_df$station)
hist(freqTable_station, xlab = "Nombre d'observations", ylab = "Nombre de stations", main = "Histogramme du nombre d'observations des stations")
```

### Les variables quantitatives

## Exploration multivariée

### Exploration des relations avec la durée des trajets

En croisant la variable `dur` avec la variable `wday` qui représente les jours de la semaine et `mem` qui représente l'abonnement, nous pouvons obtenir le figure \@ref(fig:wday). Plusieurs analyses sont pertinentes à partir de ce graphique. D'abord, les membres utilisent beaucoup plus les Bixi (au niveau de la durée) que les non-membres, et ce, peu importe le jour de la semaine. Les types d'utilisation semblent aussi changé, par exemple, les non-membres utilisent plus les Bixi les fin de semaines alors que pour les membres, la tendance semble moins claire. En effet, les membres semblent avoir une utilisation croissante la semaine et décroissante la fin de semaine. Naturellemement, on pourrait penser que c'est parce qu'ils utilisent le Bixi comme un moyen de transport régulier pour aller au travail ou à l'école par exemple.

D'un point de vue d'affaire, il pourrait être intéressant pour l'entreprise Bixi de faire des accords avec les gros employeurs de Montréal pour augmenter ses clients et accélérer la transition vers des moyens de transport plus doux.

```{r}
dat$wday <- factor(dat$wday,
                   levels = c("Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday", "Sunday"))

label <- c(`1` = "Membre", `0` = "Non membre")
```

```{r wday, fig.cap="Nom de la figure"}
ggplot(dat, aes(x=wday, y=dur,
           fill = wday)) +
  geom_bar(stat = "identity") +
  scale_fill_brewer(palette = "Blues")+
  facet_wrap(~ mem,labeller=labeller(mem=label))+
  theme(legend.position="none")+
  labs(title = "Durée totale des déplacement \npar jours selon les membres et les non membres")+
  xlab("")+
  ylab("Durée totale (en minutes) des déplacement")
```

```{r}
dat$wday <- factor(dat$wday,
                   levels = c("Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday", "Sunday"))

label <- c(`1` = "Membre", `0` = "Non membre")
```

En croisant la variable `dur` avec la variable `mm` qui représente les mois où il est possible de prendre un Bixi et `mem` qui représente l'abonnement, nous pouvons obtenir le figure \@ref(fig:mm). Plusieurs analyses sont pertinentes à partir de ce graphique. D'abord, les membres utilisent beaucoup plus les Bixi (au niveau de la durée) que les non-membres, et ce, peu importe le mois de l'année. D'une façon similaire, l'utilisation semble atteindre son pic vers août pour les deux types de clients. Il est aussi intéressant de constater que les membres utilisent moins les Bixi durant le moins de juillet. Cela semble concorder avec une affirmation précédente, les membres peuvent par exemple être en congé durant ce mois et ils utilisent donc moins les Bixi pour aller à leur occupation régulière.

```{r mm, fig.cap="Nom de la figure"}
ggplot(dat, aes(as.factor(mm), dur, fill = as.factor(mm))) +
  geom_bar(stat = "identity") +
  scale_fill_brewer(palette = "Blues")+
  facet_wrap(~ mem,labeller=labeller(mem=label))+
  theme(legend.position="none")+
  scale_x_discrete(breaks = 4:11,labels=c("Avril","Mai","Juin", "Juillet", "Août", "Septembre", "Octobre", "Novembre")) +
  labs(title = "Durée totale des déplacement \npar jours selon les membres et les non membres")+
  xlab("")+
  ylab("Durée totale (en minutes) des déplacement")
```

En croisant la variable `dur` avec la variable `temp` qui représente la température moyenne de la journée et `mem` qui représente l'abonnement, nous pouvons obtenir le figure @ref(fig:temp). Naturellement, on voit une relation positive entre la température totale moyenne et la durée totale de déplacement. La relation semble toutefois ralentir voir stagner vers les 20°C. Cela peut pourrait venir du fdit que l'utilisation des Bixi est plus élevé en été (donc les mois avec une température plus élevé). Ainsi, ce graphique donne globalement les mêmes informations que le précédent étant donné que la température est fortemement corrélée avec les mois.

Au niveau de la corrélation, elle est de 0.53 pour les non-membres et de 0.67 pour les membres.

Graphique corrélation pareil mais avec mois ?

```{r}
dat_temp <- dat %>%
  select(mem, dur, temp, avg) %>% 
  group_by(temp, mem) %>%
  summarise(dur = (mean(dur)),
            avg = mean(avg))
```

```{r temp, fig.cap="Nom de la figure"}
ggplot(dat_temp, aes(temp, dur)) +
  geom_point() +
  facet_wrap(~mem,labeller=labeller(mem=label))+
  geom_smooth(method='lm',  se=FALSE) +
  labs(title = "Durée totale des déplacement \npar jours selon les membres et les non membres")+
  xlab("Température journalière moyenne en °C")+
  ylab("Durée journalière totale moyenne des déplacement")

ggplot(dat_temp, aes(temp, avg)) +
  geom_point() +
  facet_wrap(~mem,labeller=labeller(mem=label))+
  geom_smooth(method='lm',  se=FALSE) +
  labs(title = "Durée moyenne des déplacement \npar jours selon les membres et les non membres")+
  xlab("Température journalière moyenne en °C")+
  ylab("Durée journalière moyenne des déplacement")

dat_temp_cor = dat_temp %>% 
  group_by(mem) %>%
  summarise(cor = cor(temp,dur),
            cor_avg = cor(temp,avg))
```

En croisant la variable `dur` avec la variable `rain` qui représente la précipitation totale de pluie lors de la journée et `mem` qui représente l'abonnement, nous pouvons obtenir le figure \@ref(fig:rain). Il est intéressant de constater que la relation est très semblable pour les membres et les non-membres. En effet, il semble y avoir une relation inversement proportionnelle entre la pluie et la durée totale des déplacements. C'est-à-dire qu'un peu de pluie a un effet significatif sur l'utilisation, mais l'effet se stabilise rapidement.

Au niveau de la corrélation, elle est de -0.45 pour les membres et les non-membres.

```{r}
dat_rain <- dat %>%
  select(mem, dur, rain, avg) %>% 
  group_by(rain, mem) %>%
  summarise(dur = mean(dur),
            avg = mean(avg))

```

```{r rain, fig.cap="Nom de la figure"}
ggplot(dat_rain, aes(rain, dur)) +
  geom_point() +
  facet_wrap(~mem,labeller=labeller(mem=label)) +
  geom_smooth(method='lm', se=FALSE) +
  labs(title = "Durée totale des déplacement \npar jours selon les membres et les non membres")+
  xlab("Précipitation")+
  ylab("Log naturel de la durée totale des déplacement")

ggplot(dat_rain, aes(rain, avg)) +
  geom_point() +
  facet_wrap(~mem,labeller=labeller(mem=label)) +
  geom_smooth(method='lm', se=FALSE) +
  labs(title = "Durée totale des déplacement \npar jours selon les membres et les non membres")+
  xlab("Précipitation")+
  ylab("Log naturel de la durée totale des déplacement")

dat_rain_cor = dat_rain %>% 
  group_by(mem) %>%
  summarise(cor = cor(rain,dur))
```

En croisant la variable `dur` et `avg` avec `mem` qui représente l'abonnement, nous pouvons obtenir le tableau \@ref(tab:tab-mem).

```{r}
dat_mem <- dat %>%
  select(mem, avg, dur) %>% 
  group_by(mem) %>%
  summarise(avg = mean(avg), dur = sum(dur)) %>% 
  mutate(dur_relative = ifelse(mem == 1, dur / sum(dat$mem == 1), dur / sum(dat$mem ==0))) %>% 
  mutate(mem = ifelse(mem == 1, "Membre", "Non-membre"))
```

```{r tab-mem}
kable(dat_mem, col.names = c("Membre", "Durée moyenne", "Durée totale", "Durée totale relative"), caption = "Détail sur la durée selon les abonnements")
```

La durée moyenne des trajets est assez similaire entre les membres et les non-membres. Cela est assez intéressant, car il est facile de penser que les membres utiliseraient plus les Bixi pour des trajets plus long. En revanche, les membres ont une durée totale de trajets beaucoup plus haute que les non-membres, ce qui rejoint ce que nous avions observé précédemment. Il apparait aussi que les membres sont responsables de la majeure partie des déplacements (en durée). Ainsi, selon la rentabilité du programme d'adhéesion (donnée non disponible), il pourrait être opportun d'attirer des nouveaux membres avec des promotions et des campagnes publicitaires.

En croisant la variable `dur` et `avg` avec `holiday` qui représente si le jour est férié ou non, nous pouvons obtenir le tableau \@ref(tab:tab-hol).

```{r tab-hol}
dat_hol <- dat %>%
  select(holiday, avg, dur) %>% 
  group_by(holiday) %>%
  summarise(avg = mean(avg), dur = sum(dur)) %>% 
  mutate(dur_relative = ifelse(holiday == 1, dur / sum(dat$holiday == 1), dur / sum(dat$holiday ==0))) %>% 
  mutate(holiday = ifelse(holiday == 1, "Férié", "Non férié"))


kable(dat_hol, col.names = c("Jour", "Durée moyenne", "Durée totale", "Durée totale relative"), caption = "Détail sur la durée selon les fériés")

```

La durée moyenne des trajets est légérement supérieure pour les jours fériés. Aussi, la durée totale relative des trajets est supérieure pendant les jours fériés. Cela s'explique par le fait que les usagers ont plus de temps disponible pour utiliser les Bixi. Il serait aussi avantageux pour Bixi d'augmenter la disponibilité des vélos lors des jours fériés.

```{r}
dat_station = dat %>% group_by(station) %>% summarise(dur = sum(dur))
data <- dat_station[order(-dat_station$dur), ]

# Créer un graphique à barres classant les stations en ordre décroissant
ggplot(data, aes(x = factor(station, levels = unique(data$station)), y = dur)) +
  geom_bar(stat = "identity", fill = "blue") +
  labs(x = "Station", y = "Somme de la Durée", title = "Stations Classées en Ordre Décroissant par Somme de Durée") +
  scale_x_discrete(labels = rep("", length(data$station))) +
  theme(panel.grid.major.x = element_blank(),
        axis.ticks.x = element_blank())
  
top3_stat_dur = head(data, 3)
```

En fonction de la duration, le top 3 des stations sont :

-   de la Commune / Place Jacques-Cartier

-   de la Commune / St-Sulpice

-   Métro Mont-Royal (Rivard / du Mont-Royal)

### Exploration des relations avec l'utilisation des Bixi

Dans la prochaine section, nous allons explorer les relations entre l'utilisation des Bixis, soit la variable `n_tot` (ainsi que `n_AM` et `n_PM` dans certains cas) et diverses variables de notre base de données.

La figure \@ref(fig:graph_n_tot_vs_temp) montre la relation entre le nombre de déplacement total moyen par jour par rapport à la température pour les membres et les non-membres.

```{r graph_n_tot_vs_temp}
dat_temp_ntot <- dat %>%
  select(mem, n_tot, temp) %>% 
  group_by(temp, mem) %>%
  summarise(n_tot = (mean(n_tot)))

ggplot(dat_temp_ntot, aes(temp, n_tot)) +
  geom_point() + geom_smooth(method='lm', se=FALSE) +
  facet_wrap(~mem,labeller=labeller(mem=label)) +
  labs(title = "Nombre moyen de déplacements \npar rapport à la température")+
  xlab("Température en °C")+
  ylab("Nombre de déplacement moyen")

dat_temp_ntot_cor = dat_temp_ntot %>% 
  group_by(mem) %>%
  summarise(cor = cor(temp,n_tot))
```

D'après ce graphique, il est possible de constater qu'il semble exister une relation linéaire entre le nombre de déplacement effectué en Bixi et la température, que ce soit pour un membre et un non-membre. Dans les deux cas, on observe que le nombre de déplacement moyen a tendance à augmenter avec la température. Une forte corrélation positive de 0.65 pour les membres et une corrélation moyenne de 0.48 pour les non-membres.

D'un point de vue d'affaires, si l'entreprise Bixi désirerait par exemple effectuer une mise à jour logiciel ou effectuer de la maintenance sur certains vélos et que ceci nécessiterait de récupérer une certaines quantité de Bixi, il faudrait que l'entreprise entreprenne ces changements pendant les journées où il fait plus froid, ou durant les périodes plus froides soit durant les mois d'avril, mai, octobre ou novembre comme le montre le tableau \@ref(table:graph_temp_vs_mois).

```{r graph_temp_vs_mois}

mean_temp_vs_mm <- round(aggregate(dat$temp~dat$mm, FUN=mean, na.rm = TRUE), digits=2)
kable(mean_temp_vs_mm, col.names = c("Mois","Température moyenne (°C)"), caption = "Température moyenne par mois")

```

La figure \@ref(fig:graph_n_tot_vs_rain) montre la relation entre le nombre de déplacement total moyen par jour d'après la quantité de pluie tombé dans une journée.

```{r graph_n_tot_vs_rain}
dat_rain_ntot <- dat %>%
  select(mem, n_tot, rain) %>% 
  group_by(rain, mem) %>%
  summarise(n_tot = ((n_tot)))

ggplot(dat_rain_ntot, aes(rain, n_tot)) +
  geom_point() + #geom_smooth(method='lm', se=FALSE) +
  facet_wrap(~mem,labeller=labeller(mem=label)) +
  labs(title = "Nombre moyen de déplacements \npar rapport à la quantité de précipitations")+
  xlab("Quantité de précipitations (mm) par jour")+
  ylab("Nombre de déplacement moyen")

dat_rain_ntot_cor = dat_rain_ntot %>% 
  group_by(mem) %>%
  summarise(cor = cor(rain,n_tot))
```

D'après ce graphique, il ne semble pas avoir de corrélation entre le nombre de déplacement et la quantité de précipitation dans une journée.

La figure \@ref(fig:n_tot_vs_day) montre la relation entre le nombre de déplacement moyen pour différents moment de la journée et le nombre total de déplacement d'après le jour de la semaine, ainsi que la semaine ou la fin de semaine.

```{r n_tot_vs_day}

monday <- select(filter(dat, wday == "Monday" & mem == 1),n_tot,n_AM,n_PM)
v_monday <- c(mean(monday$n_AM),mean(monday$n_PM), mean(monday$n_tot-monday$n_AM-monday$n_PM),mean(monday$n_tot))

monday_nm <- select(filter(dat, wday == "Monday" & mem == 0),n_tot,n_AM,n_PM)
v_monday_nm <- c(mean(monday_nm$n_AM),mean(monday_nm$n_PM),mean(monday_nm$n_tot-monday_nm$n_AM-monday_nm$n_PM),mean(monday_nm$n_tot))


tuesday <- select(filter(dat, wday == "Tuesday" & mem == 1),n_tot,n_AM,n_PM)
v_tuesday <- c(mean(tuesday$n_AM),mean(tuesday$n_PM), mean(tuesday$n_tot-tuesday$n_AM-tuesday$n_PM),mean(tuesday$n_tot))

tuesday_nm <- select(filter(dat, wday == "Tuesday" & mem == 0),n_tot,n_AM,n_PM)
v_tuesday_nm <- c(mean(tuesday_nm$n_AM),mean(tuesday_nm$n_PM),mean(tuesday_nm$n_tot-tuesday_nm$n_AM-tuesday_nm$n_PM),mean(tuesday_nm$n_tot))


wednesday <- select(filter(dat, wday == "Wednesday" & mem == 1),n_tot,n_AM,n_PM)
v_wednesday <- c(mean(wednesday$n_AM),mean(wednesday$n_PM), mean(wednesday$n_tot-wednesday$n_AM-wednesday$n_PM),mean(wednesday$n_tot))

wednesday_nm <- select(filter(dat, wday == "Wednesday" & mem == 0),n_tot,n_AM,n_PM)
v_wednesday_nm <- c(mean(wednesday_nm$n_AM),mean(wednesday_nm$n_PM),mean(wednesday_nm$n_tot-wednesday_nm$n_AM-wednesday_nm$n_PM),mean(wednesday_nm$n_tot))


thursday <- select(filter(dat, wday == "Thursday" & mem == 1),n_tot,n_AM,n_PM)
v_thursday <- c(mean(thursday$n_AM),mean(thursday$n_PM), mean(thursday$n_tot-thursday$n_AM-thursday$n_PM),mean(thursday$n_tot))

thursday_nm <- select(filter(dat, wday == "Thursday" & mem == 0),n_tot,n_AM,n_PM)
v_thursday_nm <- c(mean(thursday_nm$n_AM),mean(thursday_nm$n_PM),mean(thursday_nm$n_tot-thursday_nm$n_AM-thursday_nm$n_PM),mean(thursday_nm$n_tot))


friday <- select(filter(dat, wday == "Friday" & mem == 1),n_tot,n_AM,n_PM)
v_friday <- c(mean(friday$n_AM),mean(friday$n_PM), mean(friday$n_tot-friday$n_AM-friday$n_PM),mean(friday$n_tot))

friday_nm <- select(filter(dat, wday == "Friday" & mem == 0),n_tot,n_AM,n_PM)
v_friday_nm <- c(mean(friday_nm$n_AM),mean(friday_nm$n_PM),mean(friday_nm$n_tot-friday_nm$n_AM-friday_nm$n_PM),mean(friday_nm$n_tot))


saturday <- select(filter(dat, wday == "Saturday" & mem == 1),n_tot,n_AM,n_PM)
v_saturday <- c(mean(saturday$n_AM),mean(saturday$n_PM), mean(saturday$n_tot-saturday$n_AM-saturday$n_PM),mean(saturday$n_tot))

saturday_nm <- select(filter(dat, wday == "Saturday" & mem == 0),n_tot,n_AM,n_PM)
v_saturday_nm <- c(mean(saturday_nm$n_AM),mean(saturday_nm$n_PM),mean(saturday_nm$n_tot-saturday_nm$n_AM-saturday_nm$n_PM),mean(saturday_nm$n_tot))


sunday <- select(filter(dat, wday == "Sunday" & mem == 1),n_tot,n_AM,n_PM)
v_sunday <- c(mean(sunday$n_AM),mean(sunday$n_PM), mean(sunday$n_tot-sunday$n_AM-sunday$n_PM),mean(sunday$n_tot))

sunday_nm <- select(filter(dat, wday == "Sunday" & mem == 0),n_tot,n_AM,n_PM)
v_sunday_nm <- c(mean(sunday_nm$n_AM),mean(sunday_nm$n_PM),mean(sunday_nm$n_tot-sunday_nm$n_AM-sunday_nm$n_PM),mean(sunday_nm$n_tot))


v_semaine <- c(mean(v_monday[1],v_tuesday[1],v_wednesday[1],v_thursday[1],v_friday[1]),+
             mean(v_monday[2],v_tuesday[2],v_wednesday[2],v_thursday[2],v_friday[2]),+
             mean(v_monday[3],v_tuesday[3],v_wednesday[3],v_thursday[3],v_friday[3]),+
             mean(v_monday[4],v_tuesday[4],v_wednesday[4],v_thursday[4],v_friday[4]))

v_fin_semaine <- c(mean(v_saturday[1],v_sunday[1]),+
                 mean(v_saturday[2],v_sunday[2]),+
                 mean(v_saturday[3],v_sunday[3]),+
                 mean(v_saturday[4],v_sunday[4]))


v_semaine_nm <- c(mean(v_monday_nm[1],v_tuesday_nm[1],v_wednesday_nm[1],v_thursday_nm[1],v_friday_nm[1]),+
             mean(v_monday_nm[2],v_tuesday_nm[2],v_wednesday_nm[2],v_thursday_nm[2],v_friday_nm[2]),+
             mean(v_monday_nm[3],v_tuesday_nm[3],v_wednesday_nm[3],v_thursday_nm[3],v_friday_nm[3]),+
             mean(v_monday_nm[4],v_tuesday_nm[4],v_wednesday_nm[4],v_thursday_nm[4],v_friday_nm[4]))

v_fin_semaine_nm <- c(mean(v_saturday_nm[1],v_sunday_nm[1]),+
                 mean(v_saturday_nm[2],v_sunday_nm[2]),+
                 mean(v_saturday_nm[3],v_sunday_nm[3]),+
                 mean(v_saturday_nm[4],v_sunday_nm[4]))

n_tot_vs_day = ceiling(c(v_monday, v_tuesday, v_wednesday, v_thursday, v_friday, v_saturday, v_sunday, v_semaine, v_fin_semaine))
n_tot_vs_day_nm = ceiling(c(v_monday_nm, v_tuesday_nm, v_wednesday_nm, v_thursday_nm, v_friday_nm, v_saturday_nm, v_sunday_nm, v_semaine_nm, v_fin_semaine_nm))


moment <- rep(c("AM", "PM", "Nuit", "Total"),9)

day <- c(rep("Lundi",4), rep("Mardi",4), rep("Mercredi",4), rep("Jeudi",4), rep("Vendredi",4), rep("Samedi",4), rep("Dimanche",4), rep("Semaine",4), rep("Fin de semaine",4))

wday_data_n <- data.frame(moment,n_tot_vs_day,day)
wday_data_n_nm <- data.frame(moment,n_tot_vs_day_nm,day)

wday_data_n <- wday_data_n %>% mutate(day=factor(day, 
                                      levels=c("Lundi", "Mardi", "Mercredi",
                                               "Jeudi", "Vendredi", "Samedi", 
                                               "Dimanche", "Semaine", "Fin de semaine"), ordered=TRUE))

wday_data_n_nm <- wday_data_n_nm %>% mutate(day=factor(day, 
                                      levels=c("Lundi", "Mardi", "Mercredi",
                                               "Jeudi", "Vendredi", "Samedi", 
                                               "Dimanche", "Semaine", "Fin de semaine"), ordered=TRUE))

ggplot(wday_data_n, aes(fill=moment,y = n_tot_vs_day, x = day )) + geom_bar(position="dodge", stat="identity")+
geom_text(aes(label=n_tot_vs_day), position=position_dodge(width=0.9), vjust=-0.25) #+
  #geom_vline(xintercept=7.5, linetype="dotted", color="red", size = 0.8)

ggplot(wday_data_n_nm, aes(fill=moment,y = n_tot_vs_day_nm, x = day )) + geom_bar(position="dodge", stat="identity")+
geom_text(aes(label=n_tot_vs_day_nm), position=position_dodge(width=0.9), vjust=-0.25) #+
  #geom_vline(xintercept=7.5, linetype="dotted", color="red", size = 0.8)
              
```

Pour les membres, on remarque qu'en moyenne, il y a plus de déplacements en après-midi qu'en avant-midi et durant la nuit. De façon générale, il y a aussi un peu plus de déplacements en avant-midi que la nuit. Il est aussi possible de remarquer que le nombre de déplacement total est très semblable pour tous les jours. Ainsi, on remarque aussi que le nombre moyen de déplacements entre la semaine et la fin de semaine est très semblables.

Pour les non-membres, il y a aussi plus de déplacements en après-midi qu'en avant-midi et durant la nuit. Puis, l'utilisation en avant-midi et la nuit est très semblable pour tous les jours. Il est aussi possible de remarquer que le nombre de déplacement total est très semblable pour tous les jours. Ainsi, on remarque aussi que le nombre moyen de déplacements entre la semaine et la fin de semaine est semblables aussi.

D'un point de vue d'affaires, il n'y aurait pas d'avantage significatif à prioriser une journée ou une autre de la semaine si l'entreprise devait enlever une certaines quantité de Bixi des routes pour une journée.

Le tableau \\\@ref(fig:n_tot_vs_holiday) montre la relation entre le nombre de déplacement et si la journée est férié ou non.

```{r n_tot_vs_holiday}

dat_hol_n_tot <- dat %>%
  select(holiday, n_tot) %>% 
  group_by(holiday) %>%
  mutate(mean_n_tot = n_tot) %>% 
  summarise(mean_n_tot = mean(n_tot), n_tot = sum(n_tot)) %>%
  mutate(holiday = ifelse(holiday == 1, "Férié", "Non férié"))

kable(dat_hol_n_tot, col.names = c("Jour", "Nb. déplacement moyen", "Nb. déplacement total"), caption = "Détail sur le nombre de déplacement selon les fériés")

```

Ce tableau montre qu'en moyenne il y a un peu plus de déplacements durant les jours férié, mais on parle ici d'un peu plus qu'un seul déplacement. Ce qui ne semble pas assez signifiant pour conclure que le nombre de déplacement est affecté par le fait qu'il s'agit d'un jour férié ou non.

```{r tab-mem-n_tot}
dat_mem_n_tot <- dat %>%
  select(mem, n_tot) %>% 
  group_by(mem) %>%
  summarise(avg = mean(n_tot), n_tot = sum(n_tot)) %>% 
  mutate(mem = ifelse(mem == 1, "Membre", "Non-membre"))

kable(dat_mem_n_tot, col.names = c("Membre", "Nb. de déplacement moyen", "Nb. de déplacement total"), caption = "Détail sur le nombre de déplacement selon les abonnements")
```

D'après ce tableau,

Reste à faire d'après la station...

La figure \\\@ref(fig:n_tot_vs_mois) représente la relation entre l'utilisation des Bixis et le mois de l'année. Comme l'analyse univariée la démontré, nous avons très peu de données pour les mois d'avril et novembre en comparaison aux autres mois faisant partie de l'étude, ainsi nous n'allons pas les prendre en compte pour cette relation.

```{r n_tot_vs_mois}

etat <- rep(c("Membre", "Non-membre"),8)

mois <- c(rep("Avril",2), rep("Mai",2), rep("Juin",2), rep("Juillet",2), rep("Août",2), rep("Septembre",2), rep("Octobre",2), rep("Novembre",2))

dat_mem_n_tot_vs_mm <- select(filter(dat,mem == 1),n_tot,mm)
dat_nmem_n_tot_vs_mm <- select(filter(dat,mem == 0),n_tot,mm)

#v_n_tot_vs_mm <- ceiling(c(mean(filter(dat_mem_n_tot_vs_mm, mm == 4)$n_tot), mean(filter(dat_nmem_n_tot_vs_mm, mm == 4)$n_tot),+
#                       mean(filter(dat_mem_n_tot_vs_mm, mm == 5)$n_tot), mean(filter(dat_nmem_n_tot_vs_mm, mm == 5)$n_tot),+
#                       mean(filter(dat_mem_n_tot_vs_mm, mm == 6)$n_tot), mean(filter(dat_nmem_n_tot_vs_mm, mm == 6)$n_tot),+
#                       mean(filter(dat_mem_n_tot_vs_mm, mm == 7)$n_tot), mean(filter(dat_nmem_n_tot_vs_mm, mm == 7)$n_tot),+
#                       mean(filter(dat_mem_n_tot_vs_mm, mm == 8)$n_tot), mean(filter(dat_nmem_n_tot_vs_mm, mm == 8)$n_tot),+
#                       mean(filter(dat_mem_n_tot_vs_mm, mm == 9)$n_tot), mean(filter(dat_nmem_n_tot_vs_mm, mm == 9)$n_tot),+
#                       mean(filter(dat_mem_n_tot_vs_mm, mm == 10)$n_tot), mean(filter(dat_nmem_n_tot_vs_mm, mm == 10)$n_tot),+
#                       mean(filter(dat_mem_n_tot_vs_mm, mm == 11)$n_tot), mean(filter(dat_nmem_n_tot_vs_mm, mm == 11)$n_tot)))

v_n_tot_vs_mm <- c(sum(filter(dat_mem_n_tot_vs_mm, mm == 4)$n_tot), sum(filter(dat_nmem_n_tot_vs_mm, mm == 4)$n_tot),+
                       sum(filter(dat_mem_n_tot_vs_mm, mm == 5)$n_tot), sum(filter(dat_nmem_n_tot_vs_mm, mm == 5)$n_tot),+
                       sum(filter(dat_mem_n_tot_vs_mm, mm == 6)$n_tot), sum(filter(dat_nmem_n_tot_vs_mm, mm == 6)$n_tot),+
                       sum(filter(dat_mem_n_tot_vs_mm, mm == 7)$n_tot), sum(filter(dat_nmem_n_tot_vs_mm, mm == 7)$n_tot),+
                       sum(filter(dat_mem_n_tot_vs_mm, mm == 8)$n_tot), sum(filter(dat_nmem_n_tot_vs_mm, mm == 8)$n_tot),+
                       sum(filter(dat_mem_n_tot_vs_mm, mm == 9)$n_tot), sum(filter(dat_nmem_n_tot_vs_mm, mm == 9)$n_tot),+
                       sum(filter(dat_mem_n_tot_vs_mm, mm == 10)$n_tot), sum(filter(dat_nmem_n_tot_vs_mm, mm == 10)$n_tot),+
                       sum(filter(dat_mem_n_tot_vs_mm, mm == 11)$n_tot), sum(filter(dat_nmem_n_tot_vs_mm, mm == 11)$n_tot))


dmm_data_n_tot <- data.frame(etat,v_n_tot_vs_mm,mois)

#ggplot(dmm_data_n_tot, aes(fill=etat,y = v_n_tot_vs_mm, x = mois)) + geom_bar(position="dodge",stat="identity")+
#geom_text(aes(label=v_n_tot_vs_mm), position=position_dodge(width=0.9), vjust=-0.25)


dat_test <- dat %>%
  select(mem, n_tot, mm) %>% 
  group_by(mm, mem) %>%
  summarise(n_tot = (sum(n_tot)))

mois <- c(rep("Avril",2), rep("Mai",2), rep("Juin",2), rep("Juillet",2), rep("Août",2), rep("Septembre",2), rep("Octobre",2), rep("Novembre",2))

dat_test <- dat_test %>% mutate(mm=factor(mm, 
                                      levels=c(4:11), ordered=TRUE))


ggplot(dat_test, aes(x=mm, y=n_tot,
           fill = mois)) +
  geom_bar(stat = "identity") +
  scale_fill_brewer(palette = "Blues")+
  facet_wrap(~ mem,labeller=labeller(mem=label))+
  theme(legend.position="none")+
  labs(title = "Nombre de déplacement \npar jours selon les membres et les non membres")+
  xlab("")+
  ylab("Nombre de déplacement")

```

Vs les stations...

```{r n_tot_vs_station}

dat_n_tot_station <- dat %>%
  select(mem, n_tot, station) %>% 
  group_by(station, mem) %>%
  summarise(n_tot = (sum(n_tot)))%>% 
  add_count(station) %>% 
  filter(dense_rank(n_tot) < 14)


plot(dat_n_tot_station$station,dat_n_tot_station$n_tot)
```

### Exploration des relations avec le revenu

Dans cette section, il sera principalement question de la variable revenu `rev`, puisque c'est la variable qui met en relation le revenu généré par les non-membres avec les autres variables. De ce fait, d'un point de vue entrepreneurial, c'est une variable d'intérêt capital, puisqu'elle participe au calcul de profit de BIXI. Cependant, puisque l'encodage des données du revenu n'est offert que pour les non-membres et que le revenu est calculé à partir de la durée du trajet, la corrélation entre ces deux dernières est relativement forte comme on peut le voir dans le tableau \@ref(tab:CorRevDur). Conséquemment, visualiser la relation entre le revenu et les journées de la semaine `wday`, le mois `mm`, la température `temp` et les précipitations `rain` reviennent à visualiser la même chose que ce qui a été fait quelques sections plus haut, lors de l'exploration des relations avec la durée des trajets. Dès lors, il reste néanmoins intéressant d'observer comment le revenu se comporte lors des journées fériées `holiday` et les moments de la journée `n_AM`, `n_PM` et `n_Nuit`.

```{r CorRevDur, fig.align = 'right'}
kable(cor(dat$rev, dat$dur, use = "complete.obs"), caption="Corrélation entre le revenu et la durée de trajet",col.names = c(""))

```

Dans le cas de la relation entre les journées fériées et la durée du trajet, il est possible d'apercevoir qu'en moyenne les non-membres utilisent plus bixi lors des journées fériées, puisque le revenu moyen est plus élevé lors de ces journées (\@ref(tab:holiday)). Cela étant dit, il y a un parallèle à faire avec la figure illustrée plus haut \@ref(fig:wday) où l'on peut voir que les non-membres ont plus tendance à se déplacer en bixi la fin de semaine. Par conséquent, on peut soutenir l'hypothèse que l'utilisation de bixi par les non-membres est liée à des fins plus récréatives.

D'un point de vue entrepreneurial, la localisation des stations de bixi pour les non-membres devient alors cruciale. Autrement dit, placer des stations de bixi proches des lieux culturels et les lieux de divertissement pourraient ainsi favoriser le revenu de l'entreprise.

```{r holiday}

#ggplot(dat,aes(as.factor(wday), rev, fill=as.factor(wday)))+
#  geom_bar(stat = "identity")+
#  scale_fill_brewer(palette = "Blues")+
#  theme_minimal()+
#  theme(legend.position = "none")+
#  ggtitle("Revenu selon les journées de la semaine")+
#  ylab("Revenu")+
#  xlab("")

df_Nmem_compl <- dat  %>% subset(mem == '0')

dat_rev <- df_Nmem_compl %>%
  select(rev, holiday) %>% 
  group_by(holiday) %>%
  summarise(rev_moyen = mean(rev),rev_total = sum(rev)) %>% 
  mutate(holiday = ifelse(holiday == 1, "Journée fériée", "journée normale"))

dat_rev

kable(dat_rev, col.names = c("", "Revenu moyen", "Revenu total"), caption = "Détails entre les journées fériées et le revenu rapporté par les non-membres")
```

# Conclusion {.unnumbered}

voir le tableau \@ref(tab:test)

```{r test}
knitr::kable(summary(dat), caption="tableau")

```

voir la figure \@ref(fig:member1)

```{r member1, fig.cap="Nom de la figure"}
donnees_summary <- dat %>%
  group_by(mem) %>%
  summarise(percentage = n() / nrow(dat) * 100)
# Création variable pour afficher en %

# Création du graphique à barres
ggplot(data = donnees_summary, aes(x = factor(mem), y = percentage, fill = factor(mem))) +
  geom_bar(stat = "identity") +
  guides(fill=guide_legend(title = "Membre"))+
  ggtitle("Pourcentage de membre et de non membre BIXI")+
  xlab("")+
  ylab("Pourcentage")+
  theme_minimal()
```

essaie de graph

```{r}
dat %>%  ggplot(aes(avg,temp))+
  geom_point()+
  theme_minimal()

dat %>% ggplot(aes(dur))+
  geom_density()
  


```
